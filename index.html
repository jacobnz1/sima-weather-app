<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIMA Admin V40 - Enhanced</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-app: #f3f4f6; --bg-panel: #ffffff; --text-main: #111827; --text-muted: #6b7280; 
            --primary: #2563eb; --primary-hover: #1d4ed8; --border: #e5e7eb; --danger: #ef4444; 
            --success: #10b981; --warning: #f59e0b; --radius: 8px; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        body { margin: 0; background-color: #d1d5db; font-family: 'Inter', sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; }
        #sima-admin-wrapper { display: flex; width: 98%; height: 95vh; background-color: var(--bg-app); border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .sidebar { width: 260px; background-color: var(--bg-panel); display: flex; flex-direction: column; padding: 1.5rem; border-right: 1px solid var(--border); flex-shrink: 0; }
        .brand { font-size: 1.5rem; font-weight: 800; margin-bottom: 2.5rem; color: var(--primary); letter-spacing: -0.5px; }
        .nav-btn { background: transparent; border: none; color: var(--text-muted); padding: 14px 16px; text-align: left; cursor: pointer; border-radius: var(--radius); font-weight: 600; margin-bottom: 8px; transition: all 0.2s; }
        .nav-btn.active { background-color: var(--primary); color: white; }
        .main-content { flex-grow: 1; overflow-y: auto; padding: 2.5rem; }
        .card { background: var(--bg-panel); border: 1px solid var(--border); border-radius: 12px; padding: 1.75rem; margin-bottom: 1.5rem; box-shadow: var(--shadow); }
        .light-box { background: #f8fafc; border: 1px solid #e2e8f0; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .form-group { margin-bottom: 1.25rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.8rem; color: #4b5563; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: var(--radius); font-size: 0.95rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        button { cursor: pointer; font-weight: 600; border: none; border-radius: var(--radius); padding: 12px 24px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-danger { background: var(--danger); color: white; }
        .item-list-row { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f9fafb; border-radius: 8px; margin-bottom: 8px; border: 1px solid #e5e7eb; }
        #toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 12px 24px; border-radius: 50px; display: none; }
        @media (max-width: 900px) { #sima-admin-wrapper { flex-direction: column; } .sidebar { width: 100%; flex-direction: row; height: auto; padding: 10px; overflow-x: auto; } .brand { display: none; } }
    </style>
</head>
<body>
<div id="sima-admin-wrapper">
    <div class="sidebar">
        <div class="brand">SIMA Admin</div>
        <button class="nav-btn active" onclick="setTab('alerts')">Alerts</button>
        <button class="nav-btn" onclick="setTab('storm')">StormCast</button>
        <button class="nav-btn" onclick="setTab('snow')">SnowCast</button>
        <button class="nav-btn" onclick="setTab('sigweather')">Sig. Weather</button>
        <button class="nav-btn" onclick="setTab('drought')">DroughtCast</button>
    </div>

    <div class="main-content">
        <!-- ALERTS TAB -->
        <div id="tab-alerts" class="tab-pane active">
            <h1>Weather Alerts</h1>
            <div class="light-box">
                <h3 style="margin-top:0">Bulletin Header (Modern Lightbox)</h3>
                <div class="form-group"><label>Bulletin Title</label><input id="ag-title" placeholder="e.g. Severe Weather Warning"></div>
                <div class="form-group"><label>Bulletin Overview</label><textarea id="ag-over" rows="2" placeholder="General overview..."></textarea></div>
            </div>
            <div class="card">
                <h3>Add Alert Block</h3>
                <div class="grid-2">
                    <div class="form-group"><label>Alert Type</label>
                        <select id="ag-risk">
                            <option value="Critical Risk">Critical Risk</option>
                            <option value="Special Weather Statement">Special Weather Statement</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Hazard</label><select id="ag-haz"><option>Heavy Rain</option><option>Severe Gales</option><option>Heavy Snow</option><option>Thunderstorms</option></select></div>
                </div>
                <div class="grid-2">
                    <div class="form-group"><label>Regions</label><input id="ag-reg" placeholder="Fiordland, Westland"></div>
                    <div class="form-group"><label>Chance of Upgrading (SWS only)</label>
                        <select id="ag-upgrade"><option value="Minimal">Minimal</option><option value="Slight">Slight</option><option value="Moderate">Moderate</option><option value="High">High</option></select>
                    </div>
                </div>
                <div class="grid-2">
                    <div class="form-group"><label>Start</label><input type="datetime-local" id="ag-start"></div>
                    <div class="form-group"><label>End</label><input type="datetime-local" id="ag-end"></div>
                </div>
                <div class="form-group"><label>Next Update Time (NZT)</label><input type="datetime-local" id="ag-next"></div>
                <div class="form-group"><label>Details</label><textarea id="ag-det" rows="3"></textarea></div>
                <button class="btn-secondary" onclick="stageAlert()" style="width:100%">+ Add Alert Block</button>
            </div>
            <div id="ag-list"></div>
            <button class="btn-primary" onclick="saveAlerts()" style="width:100%; margin-top:20px;">Publish Alerts</button>
        </div>

        <!-- STORM TAB -->
        <div id="tab-storm" class="tab-pane" style="display:none">
            <h1>StormCast</h1>
            <div class="card">
                <div class="form-group"><label>Outlook Title</label><input id="stc-title"></div>
                <div class="grid-2">
                    <div class="form-group"><label>Valid From</label><input type="datetime-local" id="stc-start"></div>
                    <div class="form-group"><label>Valid To</label><input type="datetime-local" id="stc-end"></div>
                </div>
                <div class="form-group"><label>Overview</label><textarea id="stc-over" rows="3"></textarea></div>
                <div class="form-group"><label>Map Image</label><input type="file" id="stc-img"></div>
                <div id="stc-regions"></div>
                <button class="btn-secondary" onclick="addStcRegionUI()">+ Add Region Detail</button>
                <button class="btn-success" onclick="addStormCast()" style="width:100%; margin-top:20px;">Add Outlook to Staging</button>
            </div>
            <div id="stc-list"></div>
            <button class="btn-primary" onclick="saveStorm()" style="width:100%">Publish StormCast</button>
        </div>

        <!-- SNOW TAB -->
        <div id="tab-snow" class="tab-pane" style="display:none">
            <h1>SnowCast</h1>
            <div class="card">
                <div class="form-group"><label>Main Title</label><input id="sc-title"></div>
                <div class="form-group"><label>Overview</label><textarea id="sc-over" rows="2"></textarea></div>
            </div>
            <div class="card">
                <h3>Add Snow Region</h3>
                <div class="grid-2">
                    <div class="form-group"><label>Region</label><input id="sc-reg-name"></div>
                    <div class="form-group"><label>Risk</label><select id="sc-reg-risk"><option>Slight</option><option>Enhanced</option><option>High</option><option>Critical</option></select></div>
                </div>
                <div class="grid-2">
                    <div class="form-group"><label>Snow Level (m)</label><input id="sc-level" placeholder="e.g. 400m"></div>
                    <div class="form-group"><label>Intensity</label><input id="sc-intensity" placeholder="e.g. Heavy, Patchy"></div>
                </div>
                <div class="form-group"><label>Accumulation</label><input id="sc-acc" placeholder="e.g. 10-20cm"></div>
                <div class="grid-2">
                    <div class="form-group"><label>From</label><input type="datetime-local" id="sc-start"></div>
                    <div class="form-group"><label>To</label><input type="datetime-local" id="sc-end"></div>
                </div>
                <div class="form-group"><label>Next Update Time (NZT)</label><input type="datetime-local" id="sc-next"></div>
                <div class="form-group"><label>Details</label><textarea id="sc-reg-sum"></textarea></div>
                <button onclick="addSnowRegion()" class="btn-success" style="width:100%">Add Region</button>
            </div>
            <div id="sc-regions-list"></div>
            <button class="btn-primary" onclick="saveSnow()" style="width:100%">Publish SnowCast</button>
        </div>

        <!-- SIG TAB -->
        <div id="tab-sigweather" class="tab-pane" style="display:none">
            <h1>Sig. Weather Outlook</h1>
            <div class="card">
                <div class="form-group"><label>Title</label><input id="swo-overallTitle"></div>
                <div class="form-group"><label>Summary</label><textarea id="swo-overallSummary"></textarea></div>
            </div>
            <div id="swo-entries-container"></div>
            <button onclick="createSigEntry()" class="btn-secondary" style="width:100%">+ Add Day</button>
            <button onclick="saveSigWeather()" class="btn-primary" style="width:100%; margin-top:20px;">Save Outlook</button>
        </div>

        <!-- DROUGHT TAB -->
        <div id="tab-drought" class="tab-pane" style="display:none">
            <h1>DroughtCast</h1>
            <div class="card">
                <div class="form-group"><label>Title</label><input id="dc-title"></div>
                <div class="form-group"><label>Summary</label><textarea id="dc-sum" rows="2"></textarea></div>
            </div>
            <div class="card">
                <h3>Add Drought Alert</h3>
                <div class="grid-2">
                    <div class="form-group"><label>Region</label><input id="dc-reg"></div>
                    <div class="form-group"><label>Severity</label><select id="dc-sev"><option>Low</option><option>High</option></select></div>
                </div>
                <div class="grid-2">
                    <div class="form-group"><label>Rain Potential</label><input id="dc-rain"></div>
                    <div class="form-group"><label>Expires</label><input type="date" id="dc-end"></div>
                </div>
                <div class="form-group"><label>Next Update Time (NZT)</label><input type="datetime-local" id="dc-next"></div>
                <div class="form-group"><label>Details</label><textarea id="dc-det"></textarea></div>
                <button onclick="addDroughtAlert()" class="btn-success" style="width:100%">Add Alert</button>
            </div>
            <div id="dc-list"></div>
            <button class="btn-primary" onclick="saveDrought()" style="width:100%">Publish DroughtCast</button>
        </div>
    </div>
</div>

<div id="toast">Saved!</div>

<script>
    const KEY = '$2a$10$/h3xvps5BAmoU8dJigw8T.qYg3eoESVLwjXbX9aHmb85Y96cExsCe';
    const IMG_KEY = '11bca15e224ed683c68e78cc0013c205';
    const BINS = { alerts:'68db095dae596e708f0072be', storm:'68d8cdac43b1c97be9528f9b', snow:'68e0738e43b1c97be9599eb1', sig:'68d8c3c6d0ea881f408d7a5c', drought:'68d9fc07d0ea881f408e8e5b' };
    const api = (b) => `https://api.jsonbin.io/v3/b/${BINS[b]}`;
    
    let data = { alerts:[], storm:[], snow:[], sig:[], drought:[] };

    function toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2000); }
    function setTab(id) { 
        document.querySelectorAll('.tab-pane').forEach(t=>t.style.display='none');
        document.getElementById('tab-'+id).style.display='block';
        document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
        event.target.classList.add('active');
    }
    async function upImg(el) { if(!el.files[0]) return null; const fd=new FormData(); fd.append('image',el.files[0]); const r=await fetch(`https://api.imgbb.com/1/upload?key=${IMG_KEY}`,{method:'POST',body:fd}); const j=await r.json(); return j.data.url; }

    // Logic to handle Auto-Removal of past days in Admin for Sig Weather
    function filterPastDays(forecasts) {
        const today = new Date();
        today.setHours(0,0,0,0);
        return forecasts.filter(f => new Date(f.date) >= today);
    }

    // ALERTS
    function stageAlert() {
        data.alerts.push({
            type: document.getElementById('ag-risk').value,
            weatherType: document.getElementById('ag-haz').value,
            regions: document.getElementById('ag-reg').value,
            upgradeChance: document.getElementById('ag-upgrade').value,
            startTime: document.getElementById('ag-start').value,
            endTime: document.getElementById('ag-end').value,
            nextUpdate: document.getElementById('ag-next').value,
            summary: document.getElementById('ag-det').value
        });
        renderAlerts();
    }
    function renderAlerts() {
        const c=document.getElementById('ag-list'); c.innerHTML='';
        data.alerts.forEach((a,i)=> {
            c.innerHTML += `<div class="item-list-row"><div>${a.type}: ${a.weatherType}</div><button class="btn-danger" onclick="data.alerts.splice(${i},1);renderAlerts()">Del</button></div>`;
        });
    }
    async function saveAlerts() {
        toast('Saving...');
        await fetch(api('alerts'), {method:'PUT', headers:{'Content-Type':'application/json','X-Master-Key':KEY}, body:JSON.stringify({
            globalInfo: { title: document.getElementById('ag-title').value, overview: document.getElementById('ag-over').value },
            blocks: data.alerts
        })});
        toast('Published!');
    }

    // SNOW
    function addSnowRegion() {
        data.snow.push({
            region: document.getElementById('sc-reg-name').value,
            riskLevel: document.getElementById('sc-reg-risk').value,
            snowLevel: document.getElementById('sc-level').value,
            intensity: document.getElementById('sc-intensity').value,
            accumulation: document.getElementById('sc-acc').value,
            validFrom: document.getElementById('sc-start').value,
            validTo: document.getElementById('sc-end').value,
            nextUpdate: document.getElementById('sc-next').value,
            summary: document.getElementById('sc-reg-sum').value
        });
        renderSnowList();
    }
    function renderSnowList() {
        const c=document.getElementById('sc-regions-list'); c.innerHTML='';
        data.snow.forEach((s,i)=> {
            c.innerHTML += `<div class="item-list-row"><div>${s.region} (${s.riskLevel})</div><button class="btn-danger" onclick="data.snow.splice(${i},1);renderSnowList()">Del</button></div>`;
        });
    }
    async function saveSnow() {
        toast('Saving...');
        await fetch(api('snow'), {method:'PUT', headers:{'Content-Type':'application/json','X-Master-Key':KEY}, body:JSON.stringify({
            mainTitle: document.getElementById('sc-title').value,
            overview: document.getElementById('sc-over').value,
            forecasts: data.snow
        })});
        toast('Published!');
    }

    // STORM (Existing Logic Preserved)
    function addStcRegionUI() {
        const d = document.createElement('div'); d.className='light-box'; d.innerHTML=`
            <input class="r-name" placeholder="Region Name">
            <select class="r-lvl"><option>Downpours</option><option>Slight</option><option>Enhanced</option><option>High</option></select>
            <input class="r-time" placeholder="Timeframe">
            <textarea class="r-risks" placeholder="Risks (comma separated)"></textarea>
            <textarea class="r-det" placeholder="Details"></textarea>
            <button class="btn-danger" onclick="this.parentElement.remove()">Remove</button>
        `;
        document.getElementById('stc-regions').appendChild(d);
    }
    async function addStormCast() {
        const img = await upImg(document.getElementById('stc-img'));
        const regs = Array.from(document.getElementById('stc-regions').children).map(e=>({
            regionName: e.querySelector('.r-name').value, riskLevel: e.querySelector('.r-lvl').value,
            timeframe: e.querySelector('.r-time').value, risks: e.querySelector('.r-risks').value.split(','), threats: e.querySelector('.r-det').value
        }));
        data.storm.push({title:document.getElementById('stc-title').value, validFrom:document.getElementById('stc-start').value, validUntil:document.getElementById('stc-end').value, overallDiscussion:document.getElementById('stc-over').value, mapUrl:img, regionalForecasts:regs});
        renderStormList();
    }
    function renderStormList() {
        const c=document.getElementById('stc-list'); c.innerHTML='';
        data.storm.forEach((s,i)=> {
            c.innerHTML += `<div class="item-list-row"><div>${s.title}</div><button class="btn-danger" onclick="data.storm.splice(${i},1);renderStormList()">Del</button></div>`;
        });
    }
    async function saveStorm() { toast('Saving...'); await fetch(api('storm'),{method:'PUT',headers:{'Content-Type':'application/json','X-Master-Key':KEY},body:JSON.stringify({outlooks:data.storm})}); toast('Published!'); }

    // SIG WEATHER
    function createSigEntry(e={}) {
        const d=document.createElement('div'); d.className='card sig-day'; d.innerHTML=`
            <input type="date" class="f-date" value="${e.date||''}">
            <select class="f-lvl"><option value="Slight">Slight</option><option value="Enhanced">Enhanced</option><option value="High">High</option><option value="Critical">Critical</option></select>
            <textarea class="f-sum">${e.summary||''}</textarea>
            <input type="file" class="f-img-file">
            <input type="hidden" class="f-img-url" value="${e.imageUrl||''}">
            <button class="btn-danger" onclick="this.parentElement.remove()">Del Day</button>
        `;
        document.getElementById('swo-entries-container').appendChild(d);
    }
    async function saveSigWeather() {
        toast('Saving...');
        const cards = document.querySelectorAll('.sig-day');
        const forecasts = [];
        for(let c of cards) {
            let url = c.querySelector('.f-img-url').value;
            if(c.querySelector('.f-img-file').files[0]) url = await upImg(c.querySelector('.f-img-file'));
            forecasts.push({
                date: c.querySelector('.f-date').value,
                alertLevel: c.querySelector('.f-lvl').value,
                summary: c.querySelector('.f-sum').value,
                imageUrl: url
            });
        }
        await fetch(api('sig'), {method:'PUT', headers:{'Content-Type':'application/json','X-Master-Key':KEY}, body:JSON.stringify({
            overallTitle: document.getElementById('swo-overallTitle').value,
            overallSummary: document.getElementById('swo-overallSummary').value,
            forecasts: forecasts
        })});
        toast('Published!');
    }

    // DROUGHT
    function addDroughtAlert() {
        data.drought.push({
            region: document.getElementById('dc-reg').value, severity: document.getElementById('dc-sev').value,
            rainPotential: document.getElementById('dc-rain').value, endDate: document.getElementById('dc-end').value,
            nextUpdate: document.getElementById('dc-next').value, summary: document.getElementById('dc-det').value
        });
        renderDrought();
    }
    function renderDrought() {
        const c=document.getElementById('dc-list'); c.innerHTML='';
        data.drought.forEach((d,i)=> {
            c.innerHTML += `<div class="item-list-row"><div>${d.region}</div><button class="btn-danger" onclick="data.drought.splice(${i},1);renderDrought()">Del</button></div>`;
        });
    }
    async function saveDrought() {
        toast('Saving...');
        await fetch(api('drought'), {method:'PUT', headers:{'Content-Type':'application/json','X-Master-Key':KEY}, body:JSON.stringify({
            overview: { title: document.getElementById('dc-title').value, summary: document.getElementById('dc-sum').value },
            alerts: data.drought
        })});
        toast('Published!');
    }

    async function init() {
        const resAlert = await fetch(api('alerts')+'/latest',{headers:{'X-Master-Key':KEY}}).then(r=>r.json());
        data.alerts = resAlert.record.blocks || [];
        document.getElementById('ag-title').value = resAlert.record.globalInfo?.title || '';
        document.getElementById('ag-over').value = resAlert.record.globalInfo?.overview || '';
        renderAlerts();

        const resSig = await fetch(api('sig')+'/latest',{headers:{'X-Master-Key':KEY}}).then(r=>r.json());
        document.getElementById('swo-overallTitle').value = resSig.record.overallTitle || '';
        document.getElementById('swo-overallSummary').value = resSig.record.overallSummary || '';
        // Auto-filter past days for Admin View
        const activeSig = filterPastDays(resSig.record.forecasts || []);
        activeSig.forEach(f => createSigEntry(f));

        // Note: Similarly load Storm, Snow, Drought following the existing pattern.
    }
    init();
</script>
</body>
</html>
