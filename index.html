<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>South Island Meteorological Agency</title>
    
    <!-- ADSENSE -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8263002259646510" crossorigin="anonymous"></script>

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- CORE THEME --- */
        :root {
            --primary: #0f172a; --accent: #0ea5e9; --bg: #f8fafc; 
            --text: #334155; --card-bg: #ffffff; --border: #e2e8f0;
            /* RISK COLORS */
            --risk-slight: #facc15; --risk-enhanced: #f97316; 
            --risk-high: #ef4444; --risk-critical: #a855f7; --risk-special: #3b82f6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding-top: 70px; line-height: 1.6; }

        /* --- UTILS --- */
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        .page { display: none; animation: fade 0.3s ease; } .page.active { display: block; }
        @keyframes fade { from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);} }
        .ad-box { background: #e2e8f0; padding: 20px; text-align: center; margin: 30px 0; border-radius: 8px; color: #94a3b8; font-size: 0.8rem; border: 1px dashed #cbd5e1; }
        
        /* BADGES & BORDERS */
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        
        .bg-Slight { background: var(--risk-slight); color: #000; text-shadow: none; } 
        .bg-Enhanced { background: var(--risk-enhanced); } 
        .bg-High { background: var(--risk-high); } 
        .bg-Critical { background: var(--risk-critical); } 
        .bg-Special { background: var(--risk-special); }

        .border-Slight { border-left-color: var(--risk-slight) !important; }
        .border-Enhanced { border-left-color: var(--risk-enhanced) !important; }
        .border-High { border-left-color: var(--risk-high) !important; }
        .border-Critical { border-left-color: var(--risk-critical) !important; }
        .border-Special { border-left-color: var(--risk-special) !important; }

        /* --- NAV & HEADER --- */
        #alert-banner { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 40px; background: var(--risk-high); color: white; z-index: 1002; text-align: center; line-height: 40px; font-weight: 700; font-size: 0.9rem; cursor: pointer; }
        body.has-alert { padding-top: 110px; } body.has-alert header { top: 40px; } body.has-alert .m-menu { top: 110px; height: calc(100vh - 110px); }
        
        header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); position: fixed; top: 0; width: 100%; z-index: 1000; height: 70px; }
        .nav-wrap { max-width: 1200px; margin: 0 auto; padding: 0 20px; height: 100%; display: flex; align-items: center; justify-content: space-between; }
        .brand img { height: 45px; width: auto; }
        
        /* DESKTOP MENU & DROPDOWNS */
        .d-menu { display: none; height: 100%; align-items: center; gap: 0; } 
        @media(min-width: 950px) { .d-menu { display: flex; } }
        
        /* Shared style for Standalone Links and Dropdown Triggers */
        .nav-root-item { 
            position: relative; 
            height: 100%; 
            display: flex; 
            align-items: center; 
            padding: 0 18px; /* Consistent generous padding */
            cursor: pointer; 
            font-weight: 600; 
            font-size: 14px; 
            color: var(--text); 
            text-decoration: none;
            transition: color 0.2s, background-color 0.2s;
        }
        .nav-root-item:hover { color: var(--accent); background-color: #f8fafc; }
        .nav-root-item svg { margin-left: 6px; opacity: 0.6; width: 12px; }

        /* Dropdown Logic */
        .dropdown-menu { 
            display: none; 
            position: absolute; 
            top: 100%; 
            left: 0; 
            background: white; 
            border: 1px solid var(--border); 
            min-width: 260px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            border-radius: 0 0 8px 8px; 
            flex-direction: column; 
            overflow: hidden; 
            animation: slideDown 0.2s ease; 
        }
        .nav-root-item:hover .dropdown-menu { display: flex; }
        
        .dropdown-link { 
            padding: 14px 20px; 
            text-decoration: none; 
            color: var(--text); 
            font-size: 0.9rem; 
            border-bottom: 1px solid #f8fafc; 
            transition: 0.2s; 
        }
        .dropdown-link:hover { background: #f1f5f9; color: var(--accent); padding-left: 25px; }
        .dropdown-link:last-child { border-bottom: none; }
        
        @keyframes slideDown { from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);} }
        
        .nav-btn-refresh { background: #f1f5f9; border: 1px solid #e2e8f0; padding: 8px 14px; border-radius: 20px; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.2s; margin-left: 15px; font-weight: 600; color:#475569; }
        .nav-btn-refresh:hover { background: #e2e8f0; color:#0f172a; }

        .m-toggle { display: block; background: none; border: none; font-size: 1.5rem; cursor: pointer; } @media(min-width: 950px) { .m-toggle { display: none; } }
        
        /* MOBILE MENU - UPDATED SPACING */
        .m-menu { position: fixed; top: 70px; right: 0; width: 300px; height: 100vh; background: white; transform: translateX(100%); transition: 0.3s; padding: 25px; border-left: 1px solid var(--border); z-index: 999; display: flex; flex-direction: column; gap: 8px; overflow-y: auto; padding-bottom: 80px; } 
        .m-menu.open { transform: translateX(0); }
        .m-group-title { 
            font-size: 0.75rem; 
            font-weight: 800; 
            color: #94a3b8; 
            text-transform: uppercase; 
            margin-top: 25px; 
            margin-bottom: 8px; 
            letter-spacing: 0.5px; 
            border-bottom: 1px solid #f1f5f9; 
            padding-bottom: 5px;
        }
        .m-link { font-size: 1rem; font-weight: 600; padding: 12px 10px; border-radius: 8px; text-decoration: none; color: #334155; display: block; transition:0.1s; }
        .m-link:active { background: #f1f5f9; color: var(--accent); }

        /* --- COMPONENTS --- */
        .alert-card { background: white; border: 1px solid var(--border); border-left: 5px solid var(--risk-mod); border-radius: 8px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .ac-head { padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .ac-body { padding: 20px; }
        .ac-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; font-size: 0.9rem; }
        .ac-label { font-weight: 700; color: #64748b; font-size: 0.75rem; text-transform: uppercase; display: block; margin-bottom: 4px; }

        .fc-wrap { background: white; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); }
        .fc-hero { padding: 25px; background: linear-gradient(to right, #0f172a, #1e293b); color: white; }
        .fc-map { width: 100%; height: auto; display: block; border-bottom: 1px solid var(--border); cursor: pointer; }
        .fc-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding: 25px; }
        .fc-region { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--border); border-left: 4px solid transparent; }
        .risk-tags { display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; }
        
        /* SWO CARD UPDATED */
        .swo-card { display: flex; gap: 25px; background: white; border: 1px solid var(--border); padding: 25px; border-radius: 10px; margin-bottom: 25px; align-items: start; }
        /* Larger image, no crop, readable */
        .swo-img { width: 340px; height: auto; object-fit: contain; border-radius: 4px; border: 1px solid #e2e8f0; background: #f8fafc; flex-shrink: 0; cursor: pointer; transition: transform 0.2s; }
        .swo-img:hover { transform: scale(1.02); }
        
        @media(max-width: 850px) { 
            .swo-card { flex-direction: column; } 
            .swo-img { width: 100%; max-height: 450px; margin-bottom: 15px; }
        }
        
        /* NEWS LAYOUT */
        .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }
        .news-card { background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.3s ease; cursor: pointer; display: flex; flex-direction: column; height: 100%; }
        .news-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); border-color: var(--accent); }
        .nc-img { height: 200px; background: #e2e8f0; background-size: cover; background-position: center; position: relative; }
        .nc-tag { position: absolute; top: 15px; left: 15px; background: var(--primary); color: white; padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .nc-body { padding: 25px; flex-grow: 1; display: flex; flex-direction: column; }
        .nc-date { font-size: 0.8rem; color: #94a3b8; margin-bottom: 8px; font-weight: 500; }
        .nc-title { font-size: 1.25rem; font-weight: 800; margin-bottom: 12px; line-height: 1.3; color: var(--primary); }
        .nc-link { margin-top: auto; font-size: 0.9rem; color: var(--accent); font-weight: 700; display: flex; align-items: center; gap: 5px; }

        .article-view { background: white; border-radius: 12px; border: 1px solid var(--border); padding: 40px; margin-top: 20px; }
        .art-header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .art-img { width: 100%; max-height: 400px; object-fit: cover; border-radius: 12px; margin-bottom: 30px; }
        .art-body { font-size: 1.1rem; line-height: 1.8; color: #334155; }
        .art-body img { max-width: 100%; height: auto; border-radius: 8px; margin: 15px 0; }
        .back-btn { display: inline-block; margin-bottom: 20px; color: #64748b; text-decoration: none; font-weight: 600; cursor: pointer; }

        .dc-card { border-left: 5px solid #f59e0b; background: #fff; margin-bottom: 15px; padding: 15px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* ABOUT PAGE */
        .about-section { background: white; padding: 40px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 30px; }
        .about-section h2 { margin-top: 0; color: var(--primary); }
        .about-section h3 { margin-top: 25px; color: var(--primary); font-size: 1.2rem; }
        .risk-def { margin-bottom: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #ccc; }
        .terms-details { margin-top: 20px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
        .terms-summary { padding: 15px; background: #f1f5f9; cursor: pointer; font-weight: 600; }
        .terms-content { padding: 20px; background: white; border-top: 1px solid var(--border); font-size: 0.9rem; }

        /* HOME WIDGET */
        #si-weather-root { isolation: isolate; background-color: #ffffff !important; color: #1e293b !important; font-family: 'Inter', sans-serif; border-radius: 16px; border: 1px solid #e2e8f0; overflow: hidden; height: 650px; display: flex; margin-bottom: 30px; }
        .si-sidebar { width: 380px; background: #fff; border-right: 1px solid #e2e8f0; padding: 25px; display: flex; flex-direction: column; gap: 20px; flex-shrink: 0; overflow-y: auto; }
        .si-title h2 { margin: 0; font-size: 1.5rem; color: #0f172a; font-weight: 800; }
        .si-title p { margin: 5px 0 0; color: #64748b; font-size: 0.9rem; }
        
        .si-search { position: relative; }
        .si-search input { width: 100%; padding: 12px 15px 12px 40px; border-radius: 8px; border: 1px solid #cbd5e1; background: #f8fafc; font-family: inherit; font-size: 0.95rem; }
        .si-search input:focus { background: #fff; border-color: #0ea5e9; outline: none; box-shadow: 0 0 0 3px rgba(14,165,233,0.1); }
        .si-search svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 18px; color: #94a3b8; }
        .si-results { position: absolute; top: 105%; left: 0; width: 100%; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 50; max-height: 250px; overflow-y: auto; display: none; }
        .si-res-item { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; font-size: 0.9rem; }
        .si-res-item:hover { background: #f8fafc; color: #0ea5e9; font-weight: 600; }

        .ext-tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; margin-bottom: 10px; }
        .ext-tab { flex: 1; border: none; background: transparent; padding: 8px; font-size: 0.8rem; font-weight: 600; color: #64748b; cursor: pointer; border-radius: 6px; transition: 0.2s; }
        .ext-tab.active { background: white; color: #0f172a; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .ext-grid { display: grid; gap: 12px; }
        .ext-row { display: flex; align-items: center; padding: 12px; background: #f8fafc; border: 1px solid #f1f5f9; border-radius: 10px; }
        .ext-icon { width: 40px; height: 40px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #0ea5e9; margin-right: 15px; }
        .ext-icon svg { width: 20px; height: 20px; }
        .ext-data { display: flex; flex-direction: column; }
        .ext-val { font-weight: 800; font-size: 1.1rem; color: #0f172a; line-height: 1.1; }
        .ext-label { font-size: 0.75rem; color: #64748b; font-weight: 600; text-transform: uppercase; }
        .ext-town { font-size: 0.75rem; color: #94a3b8; }

        #si-map { flex-grow: 1; height: 100%; background: #e2e8f0; z-index: 1; }
        .leaflet-tile-pane { filter: saturate(0.5) brightness(1.05); }
        
        /* Forecast Modal */
        .fc-modal-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); z-index: 999; display: none; align-items: center; justify-content: center; }
        .fc-modal { width: 90%; max-width: 700px; height: 90%; background: white; border: 1px solid #e2e8f0; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); display: flex; flex-direction: column; overflow: hidden; animation: slideUp 0.3s ease; }
        .fc-head { padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .fc-body { padding: 30px; overflow-y: auto; flex-grow: 1; }
        .fc-close { background: #f1f5f9; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; color: #64748b; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        .fc-close:hover { background: #e2e8f0; color: #ef4444; }

        .fc-current { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f1f5f9; }
        .fc-c-icon svg { width: 80px; height: 80px; }
        .fc-c-temp { font-size: 4rem; font-weight: 800; line-height: 1; color: #0f172a; }
        .fc-c-desc { font-size: 1.1rem; color: #64748b; }
        .fc-details-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 30px; }
        .fc-d-box { background: #f8fafc; padding: 10px; border-radius: 8px; text-align: center; font-size: 0.9rem; }
        .fc-d-val { font-weight: 700; color: #0f172a; display: block; }
        
        .fc-hourly { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 15px; margin-bottom: 30px; scrollbar-width: none; }
        .fc-h-item { flex: 0 0 70px; text-align: center; padding: 10px 5px; background: #f8fafc; border-radius: 10px; border: 1px solid #f1f5f9; }
        .fc-h-time { font-size: 0.75rem; font-weight: 600; color: #94a3b8; margin-bottom: 5px; }
        .fc-h-temp { font-weight: 700; color: #334155; }
        
        .fc-daily-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f8fafc; }
        .fc-d-day { width: 80px; font-weight: 600; color: #334155; font-size: 0.9rem; flex-shrink: 0; }
        .fc-d-icon { width: 40px; text-align: center; color: #64748b; flex-shrink: 0; }
        .fc-d-data { flex-grow: 1; padding: 0 15px; font-size: 0.8rem; color: #64748b; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        .fc-d-data span { display: inline-flex; align-items: center; gap: 4px; white-space: nowrap; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; }
        .fc-d-temps { font-weight: 700; text-align: right; min-width: 70px; flex-shrink: 0; }
        .fc-d-temps span { color: #94a3b8; font-weight: 400; font-size: 0.85rem; margin-left: 5px; }
        .fc-disclaimer { margin-top: 20px; padding: 15px; background: #fff7ed; color: #9a3412; font-size: 0.8rem; border-radius: 8px; text-align: center; border: 1px solid #ffedd5; }

        /* Source Badge */
        .source-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; margin-top: 5px; }
        .source-manual { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .source-auto { background: #f3f4f6; color: #4b5563; border: 1px solid #e5e7eb; }

        @media (max-width: 900px) {
            #si-weather-root { height: auto; flex-direction: column; }
            .si-sidebar { width: 100%; border-right: none; height: auto; }
            #si-map { display: none; } 
            .fc-modal { width: 100%; height: 100%; border-radius: 0; }
            .fc-d-data { flex-direction: column; align-items: flex-start; gap: 4px; }
        }
    </style>
</head>
<body>

    <div id="alert-banner" onclick="app.router('#/alerts')">‚ö†Ô∏è Active Alerts - Click Here</div>

    <header>
        <div class="nav-wrap">
            <div class="brand" onclick="app.router('#/')"><img src="logo.png" alt="SIMA" onerror="this.style.display='none'"></div>
            
            <!-- DESKTOP DROPDOWN MENU -->
            <nav class="d-menu">
                <a onclick="app.router('#/')" class="nav-root-item">Home</a>
                
                <!-- SEVERE WEATHER GROUP -->
                <div class="nav-root-item">
                    Severe Weather <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M6 9l6 6 6-6"/></svg>
                    <div class="dropdown-menu">
                        <a onclick="app.router('#/outlook')" class="dropdown-link">Significant Weather Outlook</a>
                        <a onclick="app.router('#/alerts')" class="dropdown-link">Significant Weather Alerts</a>
                    </div>
                </div>

                <!-- FORECASTS GROUP -->
                <div class="nav-root-item">
                    Forecasts <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M6 9l6 6 6-6"/></svg>
                    <div class="dropdown-menu">
                        <a onclick="app.router('#/stormcast')" class="dropdown-link">StormCast</a>
                        <a onclick="app.router('#/snowcast')" class="dropdown-link">SnowCast</a>
                        <a onclick="app.router('#/drought')" class="dropdown-link">DroughtCast</a>
                    </div>
                </div>

                <!-- STANDALONE TABS -->
                <a onclick="app.router('#/news')" class="nav-root-item">News</a>
                <a onclick="app.router('#/radar')" class="nav-root-item">Radar</a>
                <a onclick="app.router('#/about')" class="nav-root-item">About Us</a>
            </nav>

            <div style="display:flex; align-items:center; gap:5px;">
                <button class="nav-btn-refresh" onclick="window.location.reload()">
                    <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> Refresh
                </button>
                <button class="m-toggle" onclick="document.getElementById('mm').classList.toggle('open')">‚ò∞</button>
            </div>
        </div>
    </header>

    <!-- MOBILE MENU (Restructured for intuitive grouping) -->
    <div class="m-menu" id="mm">
        <a onclick="app.router('#/')" class="m-link">Home</a>
        
        <div class="m-group-title">Severe Weather</div>
        <a onclick="app.router('#/outlook')" class="m-link">Significant Weather Outlook</a>
        <a onclick="app.router('#/alerts')" class="m-link">Significant Weather Alerts</a>
        
        <div class="m-group-title">Forecasts</div>
        <a onclick="app.router('#/stormcast')" class="m-link">StormCast</a>
        <a onclick="app.router('#/snowcast')" class="m-link">SnowCast</a>
        <a onclick="app.router('#/drought')" class="m-link">DroughtCast</a>
        
        <div class="m-group-title">General</div>
        <a onclick="app.router('#/news')" class="m-link">News</a>
        <a onclick="app.router('#/radar')" class="m-link">Radar</a>
        <a onclick="app.router('#/about')" class="m-link">About Us</a>
    </div>

    <main class="container">
        
        <!-- HOME -->
        <section id="page-home" class="page">
            <div id="si-weather-root">
                <!-- Sidebar -->
                <div class="si-sidebar">
                    <div class="si-title"><h2>South Island Forecasts</h2><p>Real-time observations & 5-day outlooks</p></div>
                    <div class="si-search">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        <input type="text" id="si-town-search" placeholder="Address or Town..." autocomplete="off">
                        <div id="si-search-results" class="si-results"></div>
                    </div>
                    <div class="si-extremes">
                        <div class="ext-tabs"><button class="ext-tab active" onclick="siWidget.switchExt('cur', this)">Current</button><button class="ext-tab" onclick="siWidget.switchExt('day', this)">Since Midnight</button></div>
                        <div class="ext-grid">
                            <div class="ext-row"><div class="ext-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></div><div class="ext-data"><span class="ext-val" id="ex-max">--</span><span class="ext-label">Hottest <span id="ex-max-loc" class="ext-town"></span></span></div></div>
                            <div class="ext-row"><div class="ext-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line></svg></div><div class="ext-data"><span class="ext-val" id="ex-min">--</span><span class="ext-label">Coldest <span id="ex-min-loc" class="ext-town"></span></span></div></div>
                            <div class="ext-row"><div class="ext-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"></path></svg></div><div class="ext-data"><span class="ext-val" id="ex-wind">--</span><span class="ext-label">Gusts <span id="ex-wind-loc" class="ext-town"></span></span></div></div>
                            <div class="ext-row"><div class="ext-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.74 5.87a8 8 0 1 1-11.31 0z"></path></svg></div><div class="ext-data"><span class="ext-val" id="ex-rain">--</span><span class="ext-label">Precip <span id="ex-rain-loc" class="ext-town"></span></span></div></div>
                        </div>
                    </div>
                    <div style="margin-top:auto; font-size:0.75rem; color:#cbd5e1; text-align:center;">Source: Open-Meteo + Local Adjustments</div>
                </div>
                <div id="si-map"></div>
                <div id="fc-modal-overlay" class="fc-modal-overlay"><div class="fc-modal"><div class="fc-head"><div><h2 style="margin:0; color:#0f172a; font-size:1.5rem;" id="fm-town">Town Name</h2><div id="fm-source" class="source-badge source-auto"></div></div><button class="fc-close" onclick="document.getElementById('fc-modal-overlay').style.display='none'">&times;</button></div><div class="fc-body" id="fm-content"></div></div></div>
            </div>
            
            <div class="ad-box">[AdSense Space]</div>
            
            <h2 style="margin-bottom:20px; border-left:4px solid var(--primary); padding-left:15px;">Latest Updates</h2>
            <div id="home-news-feed" class="news-grid"><p>Loading...</p></div>
            <button onclick="app.router('#/news')" style="margin-top:20px; width:100%; padding:12px; background:white; border:1px solid #e2e8f0; border-radius:8px; cursor:pointer; font-weight:600; color:var(--primary);">View All News & Analysis &rarr;</button>
        </section>

        <!-- DEDICATED NEWS PAGE -->
        <section id="page-news" class="page">
            <div style="text-align:center; margin-bottom:40px; padding-bottom:20px; border-bottom:1px solid #e2e8f0;">
                <h1 style="color:var(--primary); font-size:2rem;">Weather News & Analysis</h1>
                <p style="color:#64748b;">In-depth coverage of significant weather events across the South Island.</p>
            </div>
            <div id="news-feed" class="news-grid"><p>Loading News...</p></div>
            <div class="ad-box">[AdSense Space]</div>
        </section>

        <!-- ARTICLE VIEW -->
        <section id="page-article" class="page"><a onclick="app.router('#/news')" class="back-btn">&larr; Back to News</a><div id="article-content" class="article-view">Loading...</div><div class="ad-box">[AdSense Space]</div></section>

        <!-- ALERTS -->
        <section id="page-alerts" class="page">
            <div style="text-align:center; margin-bottom:40px; padding-bottom:20px; border-bottom:1px solid #e2e8f0;">
                <h1 style="color:#ef4444; font-size:2rem;">Significant Weather Alerts</h1>
                <p id="alerts-overview" style="color:#64748b; max-width:600px; margin:10px auto;">Checking for active warnings...</p>
            </div>
            <div id="alerts-feed"></div>
            <div class="ad-box">[AdSense]</div>
        </section>

        <!-- SIGNIFICANT WEATHER OUTLOOK -->
        <section id="page-outlook" class="page"><h1 style="margin-bottom:10px;">Significant Weather Outlook</h1><div style="background:white; padding:20px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:30px;"><h3 id="swo-title">Loading...</h3><p id="swo-summary" style="color:#64748b; margin-top:5px;"></p></div><div id="outlook-container"></div><div class="ad-box">[AdSense]</div></section>
        
        <!-- STORMCAST -->
        <section id="page-storm" class="page"><div style="text-align:center; margin-bottom:30px;"><h1 style="color:#0f172a;">StormCast</h1><p>Convective Outlooks & Thunderstorm Risks</p></div><div id="storm-feed"></div><div class="ad-box">[AdSense]</div></section>
        
        <!-- SNOWCAST -->
        <section id="page-snow" class="page"><div style="background:#f8fafc; padding:30px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:30px; text-align:center;"><h1 id="sc-main-title">SnowCast</h1><p id="sc-main-overview" style="color:#64748b; margin-top:10px;">Checking latest guidance...</p></div><div id="snow-feed"></div><div class="ad-box">[AdSense]</div></section>
        
        <!-- DROUGHTCAST -->
        <section id="page-drought" class="page"><h1>DroughtCast</h1><div style="background:white; padding:20px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:20px;"><h3 id="dc-title">--</h3><p id="dc-sum">--</p></div><div id="dc-feed"></div><div class="ad-box">[AdSense]</div></section>
        
        <!-- RADAR -->
        <section id="page-radar" class="page"><h1>Maps & Radar</h1><iframe src="https://embed.windy.com/embed2.html?lat=-43.5&lon=171.5&zoom=6&level=surface&overlay=radar&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=km%2Fh&metricTemp=%C2%B0C&radarRange=-1" style="width:100%; height:70vh; border:none; border-radius:12px;"></iframe></section>
        
        <!-- ABOUT PAGE -->
        <section id="page-about" class="page">
            <div class="about-section">
                <h2>About Us</h2>
                <p>At SIMA (South Island Met Agency), we understand the importance of staying informed about significant weather risks for individuals and communities across the Island. Founded on 20th June 2015 as Severe Weather NZ, we transitioned to SIMA to focus specifically on the South Island.</p>
                <p><strong>Disclaimer:</strong> We do not issue official warnings or watches‚Äîthis authority lies with MetService New Zealand. Instead, we provide independent forecasts with associated probability risks for potential severe weather, helping communities make informed decisions.</p>
                
                <h3>Severe Weather Criteria</h3>
                <div class="risk-def border-Slight"><strong>Slight Risk (Yellow):</strong> <30% chance of impactful weather. Monitor conditions.</div>
                <div class="risk-def border-Enhanced"><strong>Enhanced Risk (Orange):</strong> 30-50% chance. Preparedness is advised.</div>
                <div class="risk-def border-High"><strong>High Risk (Red):</strong> 50-70% chance. Strong potential for significant impacts.</div>
                <div class="risk-def border-Critical"><strong>Critical Risk (Purple):</strong> >70% confidence. Significant risk to life or property.</div>

                <h3>Terms & Conditions</h3>
                <details class="terms-details">
                    <summary class="terms-summary">View Terms & Conditions</summary>
                    <div class="terms-content">
                        <p><strong>1. Use:</strong> Content is for personal, non-commercial use only. Attribution to SIMA is required for reproduction.</p>
                        <p><strong>2. Accuracy:</strong> Forecasts are computer-generated guidance. We are not liable for discrepancies between forecasts and actual conditions.</p>
                        <p><strong>3. Warnings:</strong> Always refer to MetService for official warnings and emergency instructions.</p>
                        <p><strong>4. Indemnity:</strong> You agree to indemnify SIMA against claims arising from your use of our content.</p>
                        <p>¬© 2025 South Island Met Agency (SIMA). All rights reserved.</p>
                    </div>
                </details>
            </div>
        </section>

    </main>

    <div id="lb" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:2000; justify-content:center; align-items:center;" onclick="this.style.display='none'"><img id="lb-img" style="max-width:95%; max-height:95%; border-radius:4px;"></div>

<script>
    const CONFIG = { news:'69238031d0ea881f40fb9d04', sig:'68d8c3c6d0ea881f408d7a5c', storm:'68d8cdac43b1c97be9528f9b', snow:'68e0738e43b1c97be9599eb1', alerts:'68db095dae596e708f0072be', drought:'68d9fc07d0ea881f408e8e5b', key: '$2a$10$/h3xvps5BAmoU8dJigw8T.qYg3eoESVLwjXbX9aHmb85Y96cExsCe' };
    
    // --- CONFIGURATION FOR BLOGGER ---
    const BLOGGER_RSS = 'https://api.rss2json.com/v1/api.json?rss_url=https%3A%2F%2Fsouthislandmet.blogspot.com%2Ffeeds%2Fposts%2Fdefault';
    
    const getFresh = u => u + (u.includes('?')?'&':'?') + 't=' + Date.now();
    
    /* --- HOME WIDGET LOGIC --- */
    const siWidget = (function(){
        const towns=[{name:"Nelson",slug:"nelson",lat:-41.27,lng:173.28},{name:"Blenheim",slug:"blenheim",lat:-41.51,lng:173.96},{name:"Westport",slug:"westport",lat:-41.75,lng:171.60},{name:"Greymouth",slug:"greymouth",lat:-42.45,lng:171.20},{name:"Kaikoura",slug:"kaikoura",lat:-42.40,lng:173.68},{name:"Christchurch",slug:"christchurch",lat:-43.53,lng:172.63},{name:"Timaru",slug:"timaru",lat:-44.39,lng:171.25},{name:"Mt Cook",slug:"mt-cook",lat:-43.73,lng:170.10},{name:"Queenstown",slug:"queenstown",lat:-45.03,lng:168.66},{name:"Dunedin",slug:"dunedin",lat:-45.87,lng:170.50},{name:"Invercargill",slug:"invercargill",lat:-46.41,lng:168.35},{name:"Stewart Is.",slug:"stewart-island",lat:-46.89,lng:168.12}];
        let map, globalData = [], overrides = {};

        const getIcon=(c)=>{
            const iconMap = {
                0: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5" fill="#f6e05e" stroke="#eab308"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`,
                2: `<svg viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2"><path d="M17.5 19C19.9853 19 22 16.9853 22 14.5C22 12.132 20.177 10.244 17.819 10.004C17.624 6.371 14.614 3.5 11 3.5C7.386 3.5 4.376 6.371 4.181 10.004C1.823 10.244 0 12.132 0 14.5C0 16.9853 2.01472 19 4.5 19H17.5Z" fill="#e2e8f0"/></svg>`,
                45: `<svg viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2"><path d="M4 14h16M4 18h16M4 10h16" stroke-linecap="round"/></svg>`, // Fog
                61: `<svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><path d="M17.5 19C19.9853 19 22 16.9853 22 14.5C22 12.132 20.177 10.244 17.819 10.004C17.624 6.371 14.614 3.5 11 3.5C7.386 3.5 4.376 6.371 4.181 10.004C1.823 10.244 0 12.132 0 14.5C0 16.9853 2.01472 19 4.5 19H17.5Z" fill="#e2e8f0"/><line x1="8" y1="21" x2="8" y2="23"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="16" y1="21" x2="16" y2="23"/></svg>`,
                71: `<svg viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2"><path d="M17.5 19C19.9853 19 22 16.9853 22 14.5C22 12.132 20.177 10.244 17.819 10.004C17.624 6.371 14.614 3.5 11 3.5C7.386 3.5 4.376 6.371 4.181 10.004C1.823 10.244 0 12.132 0 14.5C0 16.9853 2.01472 19 4.5 19H17.5Z" fill="#e2e8f0"/><path d="M8 21l2 2m-2-2l-2 2m4-2l-2-2" stroke="#93c5fd"/></svg>`, // Snow
                80: `<svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41m11.32 11.32l1.41 1.41M2 12h2m16 0h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>`, // Showers
                95: `<svg viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>` // Thunder
            };
            
            if(iconMap[c]) return iconMap[c];
            if([0,1].includes(c)) return iconMap[0];
            if([2,3].includes(c)) return iconMap[2];
            if(c>=51&&c<=67) return iconMap[61];
            if(c>=71&&c<=77) return iconMap[71];
            return iconMap[2];
        };
        
        const getCodeText=(c)=>{ if([0,1].includes(c))return"Sunny/Clear"; if([2,3].includes(c))return"Cloudy"; if(c>=51&&c<=67)return"Rain"; if(c>=71&&c<=77)return"Snow"; return"Variable"; };

        async function init() {
            if(document.getElementById('si-map')) {
                map = L.map('si-map', {zoomControl:false, scrollWheelZoom:false}).setView([-43.5, 171.5], 6);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            }
            
            // Fetch Overrides
            try {
                const ovReq = await fetch(getFresh(`https://api.jsonbin.io/v3/b/${CONFIG.news}/latest`), {headers:{'X-Master-Key':CONFIG.key}});
                const ovJson = await ovReq.json();
                overrides = ovJson.record.overrides || {};
            } catch(e) { console.log("Override fetch error", e); }

            const lats = towns.map(t=>t.lat).join(','); const lngs = towns.map(t=>t.lng).join(',');
            const u = `https://api.open-meteo.com/v1/forecast?latitude=${lats}&longitude=${lngs}&current=temperature_2m,precipitation,wind_gusts_10m,weather_code&hourly=temperature_2m,wind_gusts_10m,precipitation&timezone=Pacific%2FAuckland`;
            const r = await fetch(u); const d = await r.json();
            globalData = Array.isArray(d) ? d : [d];
            globalData.forEach((data, i) => {
                if(map) {
                    L.circleMarker([towns[i].lat, towns[i].lng], {radius:6, color:'#0f172a', fillColor:'white', fillOpacity:1}).addTo(map).on('click', ()=>app.router(`#/forecast/${towns[i].slug}`));
                }
            });
            calcExtremes('cur');

            // SEARCH
            const input = document.getElementById('si-town-search');
            const resBox = document.getElementById('si-search-results');
            input.addEventListener('input', async (e) => {
                const val = e.target.value;
                if(val.length < 3) { resBox.style.display='none'; return; }
                const gr = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${val}&count=5&language=en&format=json`);
                const gdata = await gr.json();
                resBox.innerHTML = '';
                if(gdata.results) {
                    resBox.style.display='block';
                    gdata.results.forEach(loc => {
                        const d = document.createElement('div');
                        d.className = 'si-res-item';
                        d.innerText = `${loc.name}, ${loc.country}`;
                        d.onclick = () => {
                            // Manually fetch forecast if it's a search result not in main list
                            fetchForecast({name: loc.name, lat: loc.latitude, lng: loc.longitude});
                            resBox.style.display='none'; input.value = '';
                        };
                        resBox.appendChild(d);
                    });
                }
            });
        }

        async function fetchForecast(loc) {
            const u = `https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lng}&current=temperature_2m,precipitation,wind_gusts_10m,weather_code,relative_humidity_2m,apparent_temperature,surface_pressure&hourly=temperature_2m,wind_gusts_10m,precipitation,weather_code&daily=temperature_2m_max,temperature_2m_min,weather_code,uv_index_max,precipitation_probability_max,precipitation_sum,wind_speed_10m_max,wind_direction_10m_dominant&timezone=Pacific%2FAuckland`;
            const r = await fetch(u); const d = await r.json();
            openModal(loc, d);
        }
        
        function openTownBySlug(slug) {
            const t = towns.find(x => x.slug === slug);
            if(t) fetchForecast(t);
        }

        function openModal(town, d) {
            document.getElementById('fm-town').innerText = town.name;
            const c = document.getElementById('fm-content');
            const nowH = new Date().getHours();
            
            let html = `
                <div class="fc-current">
                    <div class="fc-c-icon">${getIcon(d.current.weather_code)}</div>
                    <div>
                        <div class="fc-c-temp">${Math.round(d.current.temperature_2m)}¬∞</div>
                        <div class="fc-c-desc">${getCodeText(d.current.weather_code)} ‚Ä¢ Wind ${Math.round(d.current.wind_gusts_10m)} kph</div>
                    </div>
                </div>
                <div class="fc-details-grid">
                    <div class="fc-d-box"><span class="fc-d-val">${d.current.relative_humidity_2m}%</span>Humidity</div>
                    <div class="fc-d-box"><span class="fc-d-val">${Math.round(d.current.apparent_temperature)}¬∞</span>Feels Like</div>
                    <div class="fc-d-box"><span class="fc-d-val">${Math.round(d.current.surface_pressure)} hPa</span>Pressure</div>
                </div>
                <h4 style="margin:0 0 15px 0; color:#94a3b8; text-transform:uppercase; font-size:0.8rem;">Next 24 Hours</h4>
                <div class="fc-hourly">
            `;
            
            for(let i=nowH; i<nowH+24; i++) {
                if(!d.hourly.time[i]) break;
                html += `<div class="fc-h-item"><div class="fc-h-time">${new Date(d.hourly.time[i]).getHours()}:00</div><div style="width:24px; height:24px; margin:0 auto;">${getIcon(d.hourly.weather_code[i])}</div><div class="fc-h-temp">${Math.round(d.hourly.temperature_2m[i])}¬∞</div></div>`;
            }

            html += `</div><h4 style="margin:20px 0 15px 0; color:#94a3b8; text-transform:uppercase; font-size:0.8rem;">5-Day Forecast</h4><div>`;

            let isManuallyOverridden = false;

            for(let i=0; i<5; i++) {
                const dateObj = new Date(d.daily.time[i]);
                const dateStr = dateObj.toLocaleDateString('en-NZ');
                
                // CHECK FOR OVERRIDE
                const overrideKey = `${town.name}_${dateStr}`;
                const ov = overrides[overrideKey];
                const isOverridden = ov && (Date.now() - ov.timestamp < 86400000); 

                if(isOverridden) isManuallyOverridden = true;

                if(isOverridden) {
                    // MANUAL DATA
                    html += `
                    <div class="fc-daily-row" style="background:#f0f9ff; border-left:4px solid #0ea5e9; padding-left:10px;">
                        <div class="fc-d-day">${i===0?'Today':dateObj.toLocaleDateString('en-NZ',{weekday:'short'})}</div>
                        <div class="fc-d-icon">${getIcon(parseInt(ov.icon))}</div>
                        <div class="fc-d-data">
                            <div style="font-weight:600; width:100%;">${ov.summary}</div>
                            <span>üå¨Ô∏è ${ov.wind}</span>
                        </div>
                        <div class="fc-d-temps">${ov.max}¬∞ <span>${ov.min}¬∞</span></div>
                    </div>`;
                } else {
                    // COMPUTER DATA
                    const getDir = (deg) => ['N','NE','E','SE','S','SW','W','NW'][Math.round(deg/45)%8];
                    const windDir = getDir(d.daily.wind_direction_10m_dominant[i]);
                    
                    html += `
                    <div class="fc-daily-row">
                        <div class="fc-d-day">${i===0?'Today':dateObj.toLocaleDateString('en-NZ',{weekday:'short'})}</div>
                        <div class="fc-d-icon">${getIcon(d.daily.weather_code[i])}</div>
                        <div class="fc-d-data">
                            <span>üíß ${d.daily.precipitation_probability_max[i]}% (~${d.daily.precipitation_sum[i]}mm)</span>
                            <span>üå¨Ô∏è ${windDir} ${Math.round(d.daily.wind_speed_10m_max[i])}km/h</span>
                            <span>‚òÄÔ∏è UV ${d.daily.uv_index_max[i].toFixed(1)}</span>
                        </div>
                        <div class="fc-d-temps">${Math.round(d.daily.temperature_2m_max[i])}¬∞ <span>${Math.round(d.daily.temperature_2m_min[i])}¬∞</span></div>
                    </div>`;
                }
            }
            
            html += `</div><div class="fc-disclaimer">‚ö†Ô∏è Disclaimer: This forecast is computer generated using global models unless marked (MANUAL). Please refer to South Island Met Agency's Hand-written forecasts as your first priority.</div>`;
            
            // UPDATE SOURCE LABEL IN HEADER
            const srcBadge = document.getElementById('fm-source');
            if(isManuallyOverridden) {
                srcBadge.className = 'source-badge source-manual';
                srcBadge.innerText = '‚úÖ Forecast by SIMA';
            } else {
                srcBadge.className = 'source-badge source-auto';
                srcBadge.innerText = 'ü§ñ Computer Model';
            }

            c.innerHTML = html;
            document.getElementById('fc-modal-overlay').style.display = 'flex';
        }

        function calcExtremes(mode) {
            let maxT=-99, minT=99, maxW=0, maxR=0;
            let lMax, lMin, lWind, lRain;
            const nowH = new Date().getHours();

            globalData.forEach((d, i) => {
                const tName = towns[i].name;
                let temp, wind, rain;
                if(mode === 'cur') { temp=d.current.temperature_2m; wind=d.current.wind_gusts_10m; rain=d.current.precipitation; }
                else { 
                    const temps=d.hourly.temperature_2m.slice(0, nowH+1); 
                    temp=Math.max(...temps); 
                    const low=Math.min(...temps);
                    if(low<minT){minT=low;lMin=tName;}
                    wind=Math.max(...d.hourly.wind_gusts_10m.slice(0, nowH+1)); 
                    rain=d.hourly.precipitation.slice(0, nowH+1).reduce((a,b)=>a+b,0); 
                }
                if(mode==='cur'){ if(temp<minT){minT=temp;lMin=tName;} }
                if(temp>maxT){maxT=temp;lMax=tName;}
                if(wind>maxW){maxW=wind;lWind=tName;}
                if(rain>maxR){maxR=rain;lRain=tName;}
            });
            document.getElementById('ex-max').innerText = maxT.toFixed(1)+'¬∞'; document.getElementById('ex-max-loc').innerText = lMax;
            document.getElementById('ex-min').innerText = minT.toFixed(1)+'¬∞'; document.getElementById('ex-min-loc').innerText = lMin;
            document.getElementById('ex-wind').innerText = maxW.toFixed(0)+'kph'; document.getElementById('ex-wind-loc').innerText = lWind;
            document.getElementById('ex-rain').innerText = maxR.toFixed(1)+'mm'; document.getElementById('ex-rain-loc').innerText = lRain;
        }

        function switchExt(m, btn) {
            document.querySelectorAll('.ext-tab').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            calcExtremes(m);
        }

        return { init, switchExt, openTownBySlug };
    })();

    /* --- APP ROUTER & BLOGGER FETCHER --- */
    const app = {
        init: () => { 
            app.fetchData(); 
            window.addEventListener('hashchange', app.route);
            window.addEventListener('load', app.route);
            siWidget.init();
            app.fetchBloggerPosts();
        },
        route: () => {
            const h = window.location.hash || '#/';
            let id = 'page-home';
            
            // HANDLE DEEP LINKING FOR TOWNS
            if(h.includes('forecast/')) {
                id = 'page-home';
                const townSlug = h.split('/')[2];
                siWidget.openTownBySlug(townSlug);
            }
            else if(h.includes('article')) { id='page-article'; app.loadArticle(h.split('/').pop()); }
            else if(h.includes('news')) id='page-news';
            else if(h.includes('outlook')) id='page-outlook';
            else if(h.includes('alerts')) id='page-alerts';
            else if(h.includes('storm')) id='page-storm';
            else if(h.includes('snow')) id='page-snow';
            else if(h.includes('drought')) id='page-drought';
            else if(h.includes('radar')) id='page-radar';
            else if(h.includes('about')) id='page-about';
            
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('mm').classList.remove('open');
            if(id==='page-home') setTimeout(() => { window.dispatchEvent(new Event('resize')); }, 100);
            window.scrollTo(0,0);
        },
        router: (p) => window.location.hash = p,
        
        // --- BLOGGER INTEGRATION ---
        fetchBloggerPosts: async () => {
            try {
                const res = await fetch(BLOGGER_RSS);
                const json = await res.json();
                
                if(json.items) {
                    window.newsData = json.items.map(entry => {
                        const id = entry.guid.split('/').pop();
                        let img = 'logo.png';
                        if (entry.thumbnail) img = entry.thumbnail.replace(/\/s72-c\//, '/s1600/'); 
                        else if (entry.enclosure && entry.enclosure.link) img = entry.enclosure.link;
                        else if (entry.content) {
                            const match = entry.content.match(/src="([^"]+)"/);
                            if (match) img = match[1];
                        }

                        return {
                            id: id,
                            title: entry.title,
                            date: new Date(entry.pubDate).toLocaleDateString(),
                            content: entry.content,
                            img: img,
                            tag: (entry.categories && entry.categories.length > 0) ? entry.categories[0] : 'Update'
                        };
                    });
                    
                    // Render Home Feed (Top 3)
                    const homeC = document.getElementById('home-news-feed');
                    homeC.innerHTML = '';
                    window.newsData.slice(0, 3).forEach(item => {
                        homeC.innerHTML += `
                        <div class="news-card" onclick="app.router('#/article/${item.id}')">
                            <div class="nc-img" style="background-image:url('${item.img}')"><span class="nc-tag">${item.tag}</span></div>
                            <div class="nc-body">
                                <div class="nc-date">${item.date}</div>
                                <div class="nc-title">${item.title}</div>
                                <div class="nc-link">Read More &rarr;</div>
                            </div>
                        </div>`;
                    });

                    // Render News Page Feed (All)
                    const newsC = document.getElementById('news-feed');
                    newsC.innerHTML = '';
                    window.newsData.forEach(item => {
                        newsC.innerHTML += `
                        <div class="news-card" onclick="app.router('#/article/${item.id}')">
                            <div class="nc-img" style="background-image:url('${item.img}')"><span class="nc-tag">${item.tag}</span></div>
                            <div class="nc-body">
                                <div class="nc-date">${item.date}</div>
                                <div class="nc-title">${item.title}</div>
                                <div class="nc-link">Read More &rarr;</div>
                            </div>
                        </div>`;
                    });
                }
            } catch(e) { console.error("Blogger Fetch Error", e); }
        },

        loadArticle: (id) => {
            const c = document.getElementById('article-content');
            c.innerHTML = '<p style="text-align:center">Loading article...</p>';
            if(!window.newsData) { setTimeout(() => app.loadArticle(id), 500); return; }
            const art = window.newsData.find(n => n.id === id);
            if(art) {
                c.innerHTML = `<div class="art-header"><div style="color:#94a3b8; font-size:0.9rem; text-transform:uppercase; font-weight:700; margin-bottom:10px;">${art.date} ‚Ä¢ ${art.tag}</div><h1 style="font-size:2rem; color:#0f172a; max-width:800px; margin:0 auto;">${art.title}</h1></div><img src="${art.img}" class="art-img"><div class="art-body">${art.content}</div>`;
            } else { c.innerHTML = '<p style="text-align:center; color:red;">Article not found.</p>'; }
        },

        fetchData: async () => {
            const now = new Date();

            // 1. ALERTS
            fetch(getFresh(`https://api.jsonbin.io/v3/b/${CONFIG.alerts}/latest`), {headers:{'X-Master-Key':CONFIG.key}}).then(r=>r.json()).then(d => {
                const data = d.record;
                const active = (data.blocks||[]).filter(b => new Date(b.endTime) > now);
                document.getElementById('alerts-overview').innerText = data.globalInfo?.overview || "";
                const c = document.getElementById('alerts-feed'); c.innerHTML = '';
                if(active.length > 0) {
                    document.getElementById('alert-banner').style.display = 'block';
                    document.getElementById('alert-banner').innerHTML = `‚ö†Ô∏è ${active.length} Active Weather Alerts`;
                    document.body.classList.add('has-alert');
                    active.forEach(b => {
                        c.innerHTML += `<div class="alert-card border-${b.type}"><div class="ac-head"><span style="font-weight:800; font-size:1.1rem;">${b.weatherType}</span><span class="badge bg-${b.type}">${b.type} Risk</span></div><div class="ac-body"><div class="ac-meta"><div><span class="ac-label">Affected Regions</span>${b.regions.join(', ')}</div><div><span class="ac-label">Valid Until</span>${new Date(b.endTime).toLocaleString()}</div></div><p style="white-space:pre-line;">${b.summary}</p></div></div>`;
                    });
                } else { c.innerHTML = '<div style="text-align:center; padding:40px; color:#94a3b8;">No active significant weather alerts.</div>'; }
            });

            // 2. STORMCAST
            fetch(getFresh(`https://api.jsonbin.io/v3/b/${CONFIG.storm}/latest`), {headers:{'X-Master-Key':CONFIG.key}}).then(r=>r.json()).then(d => {
                const active = (d.record.outlooks||[]).filter(o => new Date(o.validUntil) > now);
                const c = document.getElementById('storm-feed'); c.innerHTML = '';
                if(!active.length) c.innerHTML = '<div style="text-align:center; color:#94a3b8">No active StormCast outlooks.</div>';
                active.forEach(o => {
                    let regionsHtml = '';
                    (o.regionalForecasts||[]).forEach(r => {
                        regionsHtml += `<div class="fc-region border-${r.riskLevel}"><div style="display:flex; justify-content:space-between; margin-bottom:8px;"><strong>${r.regionName}</strong><span class="badge bg-${r.riskLevel}">${r.riskLevel}</span></div><div style="font-size:0.8rem; color:#64748b; margin-bottom:8px;">${r.timing}</div><div class="risk-tags">${(r.risks||[]).map(k=>`<span class="badge" style="background:#cbd5e1; color:#334155;">${k}</span>`).join('')}</div><p style="font-size:0.9rem; margin-top:8px;">${r.threats}</p></div>`;
                    });
                    c.innerHTML += `<div class="fc-wrap"><div class="fc-hero"><h2>${o.title}</h2><div style="font-size:0.9rem; opacity:0.9; margin-top:5px;">Valid: ${new Date(o.validFrom).toLocaleString()} &rarr; ${new Date(o.validUntil).toLocaleString()}</div><p style="margin-top:15px; max-width:700px;">${o.overallDiscussion}</p></div>${o.mapUrl ? `<img src="${o.mapUrl}" class="fc-map" onclick="document.getElementById('lb-img').src=this.src;document.getElementById('lb').style.display='flex'">` : ''}<div class="fc-grid">${regionsHtml}</div></div>`;
                });
            });

            // 3. SNOWCAST
            fetch(getFresh(`https://api.jsonbin.io/v3/b/${CONFIG.snow}/latest`), {headers:{'X-Master-Key':CONFIG.key}}).then(r=>r.json()).then(d => {
                const data = d.record;
                document.getElementById('sc-main-title').innerText = data.mainTitle || "SnowCast";
                document.getElementById('sc-main-overview').innerText = data.overview || "";
                const active = (data.forecasts||[]).filter(f => new Date(f.validTo) > now);
                const c = document.getElementById('snow-feed'); c.innerHTML = '';
                if(!active.length) c.innerHTML = '<div style="text-align:center; color:#94a3b8">No active SnowCast warnings.</div>';
                active.forEach(f => { c.innerHTML += `<div class="alert-card border-${f.riskLevel}"><div class="ac-head"><strong>${f.region}</strong><span class="badge bg-${f.riskLevel}">${f.riskLevel} Snow Risk</span></div><div class="ac-body"><div class="ac-meta"><div><span class="ac-label">Valid From</span>${new Date(f.validFrom).toLocaleString()}</div><div><span class="ac-label">Valid To</span>${new Date(f.validTo).toLocaleString()}</div></div><p>${f.summary}</p></div></div>`; });
            });

            // 4. SWO
            fetch(getFresh(`https://api.jsonbin.io/v3/b/${CONFIG.sig}/latest`), {headers:{'X-Master-Key':CONFIG.key}}).then(r=>r.json()).then(d => {
                document.getElementById('swo-title').innerText = d.record.overallTitle || "";
                document.getElementById('swo-summary').innerText = d.record.overallSummary || "";
                const c = document.getElementById('outlook-container'); c.innerHTML = '';
                const todayStart = new Date(); todayStart.setHours(0,0,0,0);
                const active = (d.record.forecasts||[]).filter(f => new Date(f.date) >= todayStart);
                active.forEach(f => { c.innerHTML += `<div class="swo-card border-${f.alertLevel}">${f.imageUrl ? `<img src="${f.imageUrl}" class="swo-img" onclick="document.getElementById('lb-img').src=this.src;document.getElementById('lb').style.display='flex'">` : ''}<div><h3 style="margin-bottom:5px;">${new Date(f.date).toLocaleDateString('en-NZ', {weekday:'long', day:'numeric', month:'long'})}</h3><span class="badge bg-${f.alertLevel}">${f.alertLevel || 'Low'} Risk</span><p style="margin-top:10px; color:#475569;">${f.summary}</p></div></div>`; });
            });

            // 5. DROUGHT
            fetch(getFresh(`https://api.jsonbin.io/v3/b/${CONFIG.drought}/latest`), {headers:{'X-Master-Key':CONFIG.key}}).then(r=>r.json()).then(d => {
                document.getElementById('dc-title').innerText = d.record.overview?.title || "";
                document.getElementById('dc-sum').innerText = d.record.overview?.summary || "";
                const c = document.getElementById('dc-feed'); c.innerHTML = '';
                (d.record.alerts||[]).forEach(a => { c.innerHTML += `<div class="dc-card"><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><strong>${a.region}</strong><span class="badge bg-${a.severity}">${a.severity}</span></div><div class="ac-meta"><div><span class="ac-label">Rain Potential</span>${a.rainPotential}</div><div><span class="ac-label">Expires</span>${new Date(a.endDate).toLocaleDateString()}</div></div><p>${a.summary}</p></div>`; });
            });
        },
    };

    document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>
