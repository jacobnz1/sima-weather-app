<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>South Island Meteorological Agency</title>
    
    <!-- ADSENSE CODE -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8263002259646510" crossorigin="anonymous"></script>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           1. CORE APP STYLES
           ========================================= */
        :root {
            --primary: #0f172a; --accent: #0ea5e9; --bg: #f8fafc; 
            --text: #334155; --card-bg: #ffffff; --border: #e2e8f0;
            --risk-low: #22c55e; --risk-mod: #f59e0b; --risk-high: #ef4444; --risk-sev: #7e22ce;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); padding-top: 70px; line-height: 1.5; }

        /* --- UTILS --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .page { display: none; animation: fade 0.3s ease; } .page.active { display: block; }
        @keyframes fade { from{opacity:0;transform:translateY(5px);}to{opacity:1;transform:translateY(0);} }
        .ad-box { background: #e2e8f0; padding: 20px; text-align: center; margin: 30px 0; border-radius: 8px; color: #94a3b8; font-size: 0.8rem; border: 1px dashed #cbd5e1; }
        .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: white; }
        .bg-Slight { background: var(--risk-low); } .bg-Enhanced { background: var(--risk-mod); } .bg-High { background: var(--risk-high); } .bg-Critical { background: var(--risk-sev); } .bg-Special { background: var(--accent); }

        /* --- NAV --- */
        #alert-banner { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 40px; background: var(--risk-high); color: white; z-index: 1002; text-align: center; line-height: 40px; font-weight: 700; font-size: 0.9rem; cursor: pointer; }
        body.has-alert { padding-top: 110px; } body.has-alert header { top: 40px; } body.has-alert .m-menu { top: 110px; height: calc(100vh - 110px); }
        header { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); border-bottom: 1px solid var(--border); position: fixed; top: 0; width: 100%; z-index: 1000; height: 70px; }
        .nav-wrap { max-width: 1200px; margin: 0 auto; padding: 0 20px; height: 100%; display: flex; align-items: center; justify-content: space-between; }
        .brand img { height: 45px; width: auto; }
        .d-menu { display: none; gap: 25px; } @media(min-width: 900px) { .d-menu { display: flex; } }
        .nav-link { cursor: pointer; font-weight: 600; font-size: 14px; color: var(--text); text-decoration: none; } .nav-link:hover { color: var(--accent); }
        .m-toggle { display: block; background: none; border: none; font-size: 1.5rem; cursor: pointer; } @media(min-width: 900px) { .m-toggle { display: none; } }
        .m-menu { position: fixed; top: 70px; right: 0; width: 250px; height: 100vh; background: white; transform: translateX(100%); transition: 0.3s; padding: 20px; border-left: 1px solid var(--border); z-index: 999; display: flex; flex-direction: column; gap: 15px; } .m-menu.open { transform: translateX(0); }

        /* --- COMPONENTS --- */
        .alert-card { background: white; border: 1px solid var(--border); border-left: 5px solid var(--risk-mod); border-radius: 8px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .alert-card.crit { border-left-color: var(--risk-high); }
        .ac-head { padding: 15px 20px; background: #f8fafc; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .ac-body { padding: 20px; }
        .ac-meta { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; font-size: 0.9rem; }
        .ac-label { font-weight: 700; color: #64748b; font-size: 0.75rem; text-transform: uppercase; display: block; margin-bottom: 4px; }

        .fc-wrap { background: white; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); }
        .fc-hero { padding: 25px; background: linear-gradient(to right, #0f172a, #1e293b); color: white; }
        .fc-map { width: 100%; height: auto; display: block; border-bottom: 1px solid var(--border); }
        .fc-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding: 25px; }
        .fc-region { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--border); }
        .risk-tags { display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; }
        
        .swo-card { display: flex; gap: 20px; background: white; border: 1px solid var(--border); padding: 20px; border-radius: 10px; margin-bottom: 20px; align-items: start; }
        @media(max-width: 600px) { .swo-card { flex-direction: column; } }
        .swo-img { width: 120px; height: 120px; object-fit: cover; border-radius: 8px; background: #e2e8f0; flex-shrink: 0; }
        
        .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .news-card { background: white; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; transition: transform 0.2s; cursor: pointer; display: flex; flex-direction: column; }
        .news-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .nc-img { height: 180px; background: #e2e8f0; background-size: cover; background-position: center; }
        .nc-body { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .nc-date { font-size: 0.8rem; color: #94a3b8; margin-bottom: 8px; }
        .nc-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 10px; line-height: 1.3; color: var(--primary); }
        .nc-link { margin-top: auto; font-size: 0.9rem; color: var(--accent); font-weight: 600; }

        .article-view { background: white; border-radius: 12px; border: 1px solid var(--border); padding: 40px; margin-top: 20px; }
        .art-header { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .art-img { width: 100%; max-height: 400px; object-fit: cover; border-radius: 12px; margin-bottom: 30px; }
        .art-body { font-size: 1.1rem; line-height: 1.8; color: #334155; }
        .art-body img { max-width: 100%; height: auto; border-radius: 8px; margin: 15px 0; }
        .back-btn { display: inline-block; margin-bottom: 20px; color: #64748b; text-decoration: none; font-weight: 600; cursor: pointer; }

        .dc-card { border-left: 5px solid #f59e0b; background: #fff; margin-bottom: 15px; padding: 15px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* =========================================
           2. HOME PAGE FORECAST WIDGET
           ========================================= */
        #si-weather-root {
            isolation: isolate;
            background-color: #ffffff !important;
            color: #1e293b !important;
            font-family: 'Inter', sans-serif;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            height: 650px;
            display: flex;
            margin-bottom: 30px;
        }
        /* Sidebar (Left) */
        .si-sidebar {
            width: 380px;
            background: #fff;
            border-right: 1px solid #e2e8f0;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            flex-shrink: 0;
            overflow-y: auto;
        }
        .si-title h2 { margin: 0; font-size: 1.5rem; color: #0f172a; font-weight: 800; }
        .si-title p { margin: 5px 0 0; color: #64748b; font-size: 0.9rem; }
        
        /* Search */
        .si-search { position: relative; }
        .si-search input { width: 100%; padding: 12px 15px 12px 40px; border-radius: 8px; border: 1px solid #cbd5e1; background: #f8fafc; font-family: inherit; font-size: 0.95rem; }
        .si-search input:focus { background: #fff; border-color: #0ea5e9; outline: none; box-shadow: 0 0 0 3px rgba(14,165,233,0.1); }
        .si-search svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 18px; color: #94a3b8; }
        .si-results { position: absolute; top: 105%; left: 0; width: 100%; background: white; border: 1px solid #e2e8f0; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); z-index: 50; max-height: 250px; overflow-y: auto; display: none; }
        .si-res-item { padding: 12px 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; font-size: 0.9rem; }
        .si-res-item:hover { background: #f8fafc; color: #0ea5e9; font-weight: 600; }

        /* Extremes Tabs & Grid */
        .ext-tabs { display: flex; background: #f1f5f9; padding: 4px; border-radius: 8px; margin-bottom: 10px; }
        .ext-tab { flex: 1; border: none; background: transparent; padding: 8px; font-size: 0.8rem; font-weight: 600; color: #64748b; cursor: pointer; border-radius: 6px; transition: 0.2s; }
        .ext-tab.active { background: white; color: #0f172a; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        .ext-grid { display: grid; gap: 12px; }
        .ext-row { display: flex; align-items: center; padding: 12px; background: #f8fafc; border: 1px solid #f1f5f9; border-radius: 10px; }
        .ext-icon { width: 40px; height: 40px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #0ea5e9; margin-right: 15px; }
        .ext-icon svg { width: 20px; height: 20px; }
        .ext-data { display: flex; flex-direction: column; }
        .ext-val { font-weight: 800; font-size: 1.1rem; color: #0f172a; line-height: 1.1; }
        .ext-label { font-size: 0.75rem; color: #64748b; font-weight: 600; text-transform: uppercase; }
        .ext-town { font-size: 0.75rem; color: #94a3b8; }

        /* Map (Right) */
        #si-map { flex-grow: 1; height: 100%; background: #e2e8f0; z-index: 1; }
        .leaflet-tile-pane { filter: saturate(0.5) brightness(1.05); } /* Light aesthetic */
        
        /* Modal */
        .fc-modal-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(4px); z-index: 999; display: none; align-items: center; justify-content: center; }
        .fc-modal { width: 90%; max-width: 700px; height: 90%; background: white; border: 1px solid #e2e8f0; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); display: flex; flex-direction: column; overflow: hidden; animation: slideUp 0.3s ease; }
        .fc-head { padding: 20px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .fc-body { padding: 30px; overflow-y: auto; flex-grow: 1; }
        .fc-close { background: #f1f5f9; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; color: #64748b; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; }
        .fc-close:hover { background: #e2e8f0; color: #ef4444; }

        /* Modal Content */
        .fc-current { display: flex; align-items: center; gap: 20px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #f1f5f9; }
        .fc-c-icon svg { width: 80px; height: 80px; }
        .fc-c-temp { font-size: 4rem; font-weight: 800; line-height: 1; color: #0f172a; }
        .fc-c-desc { font-size: 1.1rem; color: #64748b; }
        
        .fc-hourly { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 15px; margin-bottom: 30px; scrollbar-width: none; }
        .fc-h-item { flex: 0 0 70px; text-align: center; padding: 10px 5px; background: #f8fafc; border-radius: 10px; border: 1px solid #f1f5f9; }
        .fc-h-time { font-size: 0.75rem; font-weight: 600; color: #94a3b8; margin-bottom: 5px; }
        .fc-h-temp { font-weight: 700; color: #334155; }
        
        .fc-daily-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #f8fafc; }
        .fc-d-day { width: 100px; font-weight: 600; color: #334155; }
        .fc-d-icon { width: 40px; text-align: center; color: #64748b; }
        .fc-d-sum { flex-grow: 1; padding: 0 15px; font-size: 0.9rem; color: #64748b; }
        .fc-d-temps { font-weight: 700; text-align: right; min-width: 80px; }
        .fc-d-temps span { color: #94a3b8; font-weight: 400; font-size: 0.9rem; margin-left: 5px; }

        @media (max-width: 900px) {
            #si-weather-root { height: auto; flex-direction: column; }
            .si-sidebar { width: 100%; border-right: none; height: auto; }
            #si-map { display: none; } /* Hide Map on Mobile */
            .fc-modal { width: 100%; height: 100%; border-radius: 0; }
        }
    </style>
</head>
<body>

    <div id="alert-banner" onclick="app.router('#/alerts')">⚠️ Active Alerts - Click Here</div>

    <header>
        <div class="nav-wrap">
            <div class="brand" onclick="app.router('#/')"><img src="logo.png" alt="SIMA" onerror="this.style.display='none'"></div>
            <nav class="d-menu">
                <a onclick="app.router('#/')" class="nav-link">Home</a>
                <a onclick="app.router('#/outlook')" class="nav-link">Outlook</a>
                <a onclick="app.router('#/alerts')" class="nav-link">Alerts</a>
                <a onclick="app.router('#/stormcast')" class="nav-link">StormCast</a>
                <a onclick="app.router('#/snowcast')" class="nav-link">SnowCast</a>
                <a onclick="app.router('#/drought')" class="nav-link">DroughtCast</a>
                <a onclick="app.router('#/radar')" class="nav-link">Radar</a>
            </nav>
            <button class="m-toggle" onclick="document.getElementById('mm').classList.toggle('open')">☰</button>
        </div>
    </header>

    <div class="m-menu" id="mm">
        <a onclick="app.router('#/')" class="nav-link">Home</a>
        <a onclick="app.router('#/outlook')" class="nav-link">Outlook</a>
        <a onclick="app.router('#/alerts')" class="nav-link">Alerts</a>
        <a onclick="app.router('#/stormcast')" class="nav-link">StormCast</a>
        <a onclick="app.router('#/snowcast')" class="nav-link">SnowCast</a>
        <a onclick="app.router('#/drought')" class="nav-link">DroughtCast</a>
        <a onclick="app.router('#/radar')" class="nav-link">Radar</a>
    </div>

    <main class="container">
        
        <!-- HOME -->
        <section id="page-home" class="page">
            
            <!-- NEW FORECAST WIDGET -->
            <div id="si-weather-root">
                <!-- Sidebar -->
                <div class="si-sidebar">
                    <div class="si-title">
                        <h2>South Island Forecasts</h2>
                        <p>Real-time observations & 5-day outlooks</p>
                    </div>
                    
                    <div class="si-search">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        <input type="text" id="si-town-search" placeholder="Search for your town..." autocomplete="off">
                        <div id="si-search-results" class="si-results"></div>
                    </div>

                    <!-- Extremes Panel -->
                    <div class="si-extremes">
                        <div class="ext-tabs">
                            <button class="ext-tab active" onclick="siWidget.switchExt('cur', this)">Current</button>
                            <button class="ext-tab" onclick="siWidget.switchExt('day', this)">Since Midnight</button>
                        </div>
                        <div class="ext-grid">
                            <div class="ext-row">
                                <div class="ext-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg></div>
                                <div class="ext-data"><span class="ext-val" id="ex-max">--</span><span class="ext-label">Hottest <span id="ex-max-loc" class="ext-town"></span></span></div>
                            </div>
                            <div class="ext-row">
                                <div class="ext-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="5" y1="12" x2="19" y2="12"></line></svg></div>
                                <div class="ext-data"><span class="ext-val" id="ex-min">--</span><span class="ext-label">Coldest <span id="ex-min-loc" class="ext-town"></span></span></div>
                            </div>
                            <div class="ext-row">
                                <div class="ext-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"></path></svg></div>
                                <div class="ext-data"><span class="ext-val" id="ex-wind">--</span><span class="ext-label">Gusts <span id="ex-wind-loc" class="ext-town"></span></span></div>
                            </div>
                            <div class="ext-row">
                                <div class="ext-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2.69l5.74 5.87a8 8 0 1 1-11.31 0z"></path></svg></div>
                                <div class="ext-data"><span class="ext-val" id="ex-rain">--</span><span class="ext-label">Precip <span id="ex-rain-loc" class="ext-town"></span></span></div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top:auto; font-size:0.75rem; color:#cbd5e1; text-align:center;">Source: Open-Meteo + Local Adjustments</div>
                </div>

                <!-- Map (Right) -->
                <div id="si-map"></div>

                <!-- Forecast Modal -->
                <div id="fc-modal-overlay" class="fc-modal-overlay">
                    <div class="fc-modal">
                        <div class="fc-head">
                            <div>
                                <h2 style="margin:0; color:#0f172a; font-size:1.5rem;" id="fm-town">Town Name</h2>
                                <span style="font-size:0.85rem; color:#64748b;">Live Forecast</span>
                            </div>
                            <button class="fc-close" onclick="document.getElementById('fc-modal-overlay').style.display='none'">&times;</button>
                        </div>
                        <div class="fc-body" id="fm-content">
                            <!-- Content injected via JS -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="ad-box">[AdSense Space]</div>
            
            <h2 style="margin-bottom:20px; border-left:4px solid var(--primary); padding-left:15px;">Latest News & Analysis</h2>
            <div id="news-feed" class="news-grid"><p>Loading News...</p></div>
        </section>

        <!-- NEWS DETAIL VIEW -->
        <section id="page-article" class="page">
            <a onclick="app.router('#/')" class="back-btn">&larr; Back to Home</a>
            <div id="article-content" class="article-view">Loading...</div>
            <div class="ad-box">[AdSense Space]</div>
        </section>

        <!-- ALERTS -->
        <section id="page-alerts" class="page">
            <div style="text-align:center; margin-bottom:40px; padding-bottom:20px; border-bottom:1px solid #e2e8f0;">
                <h1 style="color:#ef4444; font-size:2rem;">Significant Weather Alerts</h1>
                <p id="alerts-overview" style="color:#64748b; max-width:600px; margin:10px auto;">Checking for active warnings...</p>
            </div>
            <div id="alerts-feed"></div>
            <div class="ad-box">[AdSense]</div>
        </section>

        <!-- OUTLOOK -->
        <section id="page-outlook" class="page">
            <h1 style="margin-bottom:10px;">Significant Weather Outlook</h1>
            <div style="background:white; padding:20px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:30px;">
                <h3 id="swo-title">Loading...</h3>
                <p id="swo-summary" style="color:#64748b; margin-top:5px;"></p>
            </div>
            <div id="outlook-container"></div>
            <div class="ad-box">[AdSense]</div>
        </section>

        <!-- STORMCAST -->
        <section id="page-storm" class="page">
            <div style="text-align:center; margin-bottom:30px;">
                <h1 style="color:#0f172a;">StormCast</h1>
                <p>Convective Outlooks & Thunderstorm Risks</p>
            </div>
            <div id="storm-feed"></div>
            <div class="ad-box">[AdSense]</div>
        </section>

        <!-- SNOWCAST -->
        <section id="page-snow" class="page">
            <div style="background:#f8fafc; padding:30px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:30px; text-align:center;">
                <h1 id="sc-main-title">SnowCast</h1>
                <p id="sc-main-overview" style="color:#64748b; margin-top:10px;">Checking latest guidance...</p>
            </div>
            <div id="snow-feed"></div>
            <div class="ad-box">[AdSense]</div>
        </section>

        <!-- DROUGHT -->
        <section id="page-drought" class="page">
            <h1>DroughtCast</h1>
            <div style="background:white; padding:20px; border-radius:8px; border:1px solid #e2e8f0; margin-bottom:20px;">
                <h3 id="dc-title">--</h3>
                <p id="dc-sum">--</p>
            </div>
            <div id="dc-feed"></div>
            <div class="ad-box">[AdSense]</div>
        </section>

        <!-- RADAR -->
        <section id="page-radar" class="page">
            <h1>Maps & Radar</h1>
            <iframe src="https://embed.windy.com/embed2.html?lat=-43.5&lon=171.5&zoom=6&level=surface&overlay=radar&menu=&message=&marker=&calendar=now&pressure=&type=map&location=coordinates&detail=&metricWind=km%2Fh&metricTemp=%C2%B0C&radarRange=-1" style="width:100%; height:70vh; border:none; border-radius:12px;"></iframe>
        </section>

    </main>

    <!-- LIGHTBOX -->
    <div id="lb" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:2000; justify-content:center; align-items:center;" onclick="this.style.display='none'">
        <img id="lb-img" style="max-width:95%; max-height:95%; border-radius:4px;">
    </div>

<script>
    const CONFIG = { news:'69238031d0ea881f40fb9d04', sig:'68d8c3c6d0ea881f408d7a5c', storm:'68d8cdac43b1c97be9528f9b', snow:'68e0738e43b1c97be9599eb1', alerts:'68db095dae596e708f0072be', drought:'68d9fc07d0ea881f408e8e5b', key: '$2a$10$/h3xvps5BAmoU8dJigw8T.qYg3eoESVLwjXbX9aHmb85Y96cExsCe' };
    const getFresh = u => u + (u.includes('?')?'&':'?') + 't=' + Date.now();
    
    /* --- HOME WIDGET LOGIC --- */
    const siWidget = (function(){
        const towns=[
            {name:"Nelson",lat:-41.27,lng:173.28},{name:"Blenheim",lat:-41.51,lng:173.96},{name:"Takaka",lat:-40.85,lng:172.80},{name:"Westport",lat:-41.75,lng:171.60},
            {name:"Greymouth",lat:-42.45,lng:171.20},{name:"Hokitika",lat:-42.71,lng:170.96},{name:"Kaikoura",lat:-42.40,lng:173.68},{name:"Hanmer Springs",lat:-42.51,lng:172.81},
            {name:"Christchurch",lat:-43.53,lng:172.63},{name:"Ashburton",lat:-43.90,lng:171.74},{name:"Timaru",lat:-44.39,lng:171.25},{name:"Tekapo",lat:-44.00,lng:170.47},
            {name:"Mt Cook",lat:-43.73,lng:170.10},{name:"Wanaka",lat:-44.70,lng:169.15},{name:"Queenstown",lat:-45.03,lng:168.66},{name:"Alexandra",lat:-45.24,lng:169.37},
            {name:"Milford Sound",lat:-44.64,lng:167.89},{name:"Oamaru",lat:-45.09,lng:170.96},{name:"Dunedin",lat:-45.87,lng:170.50},{name:"Balclutha",lat:-46.23,lng:169.73},
            {name:"Gore",lat:-46.10,lng:168.94},{name:"Invercargill",lat:-46.41,lng:168.35},{name:"Stewart Is.",lat:-46.89,lng:168.12}
        ];
        let map, globalData = [];

        const getIcon=(c)=>{
            if([0,1].includes(c)) return `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5" fill="#f6e05e" stroke="#eab308"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>`;
            if([2,3].includes(c)) return `<svg viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2"><path d="M17.5 19C19.9853 19 22 16.9853 22 14.5C22 12.132 20.177 10.244 17.819 10.004C17.624 6.371 14.614 3.5 11 3.5C7.386 3.5 4.376 6.371 4.181 10.004C1.823 10.244 0 12.132 0 14.5C0 16.9853 2.01472 19 4.5 19H17.5Z" fill="#e2e8f0"/></svg>`;
            if(c>=51&&c<=67) return `<svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2"><path d="M17.5 19C19.9853 19 22 16.9853 22 14.5C22 12.132 20.177 10.244 17.819 10.004C17.624 6.371 14.614 3.5 11 3.5C7.386 3.5 4.376 6.371 4.181 10.004C1.823 10.244 0 12.132 0 14.5C0 16.9853 2.01472 19 4.5 19H17.5Z" fill="#e2e8f0"/><line x1="8" y1="21" x2="8" y2="23"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="16" y1="21" x2="16" y2="23"/></svg>`;
            return `<svg viewBox="0 0 24 24" fill="none" stroke="#94a3b8" stroke-width="2"><path d="M17.5 19C19.9853 19 22 16.9853 22 14.5C22 12.132 20.177 10.244 17.819 10.004C17.624 6.371 14.614 3.5 11 3.5C7.386 3.5 4.376 6.371 4.181 10.004C1.823 10.244 0 12.132 0 14.5C0 16.9853 2.01472 19 4.5 19H17.5Z" fill="#e2e8f0"/></svg>`;
        };
        const getCodeText=(c)=>{ if([0,1].includes(c))return"Sunny/Clear"; if([2,3].includes(c))return"Cloudy"; if(c>=51&&c<=67)return"Rain/Drizzle"; if(c>=71&&c<=77)return"Snow"; if(c>=95)return"Thunderstorms"; return"Variable"; };

        async function init() {
            // Init Map
            if(document.getElementById('si-map')) {
                map = L.map('si-map', {zoomControl:false, scrollWheelZoom:false}).setView([-43.5, 171.5], 6);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
            }

            // Fetch Data
            const lats = towns.map(t=>t.lat).join(',');
            const lngs = towns.map(t=>t.lng).join(',');
            const u = `https://api.open-meteo.com/v1/forecast?latitude=${lats}&longitude=${lngs}&current=temperature_2m,precipitation,wind_gusts_10m,weather_code&hourly=temperature_2m,wind_gusts_10m,precipitation,weather_code&daily=temperature_2m_max,temperature_2m_min,weather_code&timezone=Pacific%2FAuckland`;
            
            const r = await fetch(u);
            const d = await r.json();
            globalData = Array.isArray(d) ? d : [d];

            // Markers & Extremes
            globalData.forEach((data, i) => {
                const t = towns[i];
                if(map) {
                    const m = L.circleMarker([t.lat, t.lng], {radius:6, color:'#0f172a', fillColor:'white', fillOpacity:1}).addTo(map);
                    m.on('click', () => openModal(t, data));
                }
            });
            calcExtremes('cur');

            // Search
            document.getElementById('si-town-search').addEventListener('input', (e) => {
                const v = e.target.value.toLowerCase();
                const res = document.getElementById('si-search-results');
                res.innerHTML = '';
                if(v.length < 2) { res.style.display='none'; return; }
                const matches = towns.filter(t => t.name.toLowerCase().includes(v));
                if(matches.length) {
                    res.style.display='block';
                    matches.forEach(t => {
                        const div = document.createElement('div');
                        div.className='si-res-item';
                        div.innerText = t.name;
                        div.onclick = () => {
                            const idx = towns.findIndex(x => x.name === t.name);
                            openModal(t, globalData[idx]);
                            res.style.display='none';
                            e.target.value = '';
                        };
                        res.appendChild(div);
                    });
                } else res.style.display='none';
            });
        }

        function calcExtremes(mode) {
            let maxT=-99, minT=99, maxW=0, maxR=0;
            let lMax, lMin, lWind, lRain;
            const nowH = new Date().getHours();

            globalData.forEach((d, i) => {
                const tName = towns[i].name;
                let temp, wind, rain;

                if(mode === 'cur') {
                    temp = d.current.temperature_2m;
                    wind = d.current.wind_gusts_10m;
                    rain = d.current.precipitation;
                } else {
                    // Since midnight
                    const temps = d.hourly.temperature_2m.slice(0, nowH+1);
                    temp = Math.max(...temps); // High for 'hot', but loop for min
                    const low = Math.min(...temps);
                    
                    if(low < minT) { minT = low; lMin = tName; } // Specific check for daily low
                    
                    wind = Math.max(...d.hourly.wind_gusts_10m.slice(0, nowH+1));
                    rain = d.hourly.precipitation.slice(0, nowH+1).reduce((a,b)=>a+b,0);
                }

                if(mode === 'cur') {
                    if(temp < minT) { minT = temp; lMin = tName; }
                }
                
                if(temp > maxT) { maxT = temp; lMax = tName; }
                if(wind > maxW) { maxW = wind; lWind = tName; }
                if(rain > maxR) { maxR = rain; lRain = tName; }
            });

            document.getElementById('ex-max').innerText = maxT.toFixed(1)+'°'; document.getElementById('ex-max-loc').innerText = lMax;
            document.getElementById('ex-min').innerText = minT.toFixed(1)+'°'; document.getElementById('ex-min-loc').innerText = lMin;
            document.getElementById('ex-wind').innerText = maxW.toFixed(0)+'kph'; document.getElementById('ex-wind-loc').innerText = lWind;
            document.getElementById('ex-rain').innerText = maxR.toFixed(1)+'mm'; document.getElementById('ex-rain-loc').innerText = lRain;
        }

        function switchExt(m, btn) {
            document.querySelectorAll('.ext-tab').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            calcExtremes(m);
        }

        function openModal(town, d) {
            document.getElementById('fm-town').innerText = town.name;
            const c = document.getElementById('fm-content');
            const nowH = new Date().getHours();
            
            let html = `
                <div class="fc-current">
                    <div class="fc-c-icon">${getIcon(d.current.weather_code)}</div>
                    <div>
                        <div class="fc-c-temp">${Math.round(d.current.temperature_2m)}°</div>
                        <div class="fc-c-desc">${getCodeText(d.current.weather_code)} • Wind ${Math.round(d.current.wind_gusts_10m)} kph</div>
                    </div>
                </div>
                <h4 style="margin:0 0 15px 0; color:#94a3b8; text-transform:uppercase; font-size:0.8rem;">Next 24 Hours</h4>
                <div class="fc-hourly">
            `;
            
            // Hourly
            for(let i=nowH; i<nowH+24; i++) {
                if(!d.hourly.time[i]) break;
                html += `
                <div class="fc-h-item">
                    <div class="fc-h-time">${new Date(d.hourly.time[i]).getHours()}:00</div>
                    <div style="width:24px; height:24px; margin:0 auto;">${getIcon(d.hourly.weather_code[i])}</div>
                    <div class="fc-h-temp">${Math.round(d.hourly.temperature_2m[i])}°</div>
                </div>`;
            }

            html += `</div><h4 style="margin:20px 0 15px 0; color:#94a3b8; text-transform:uppercase; font-size:0.8rem;">5-Day Forecast</h4><div>`;

            // Daily
            for(let i=0; i<5; i++) {
                html += `
                <div class="fc-daily-row">
                    <div class="fc-d-day">${i===0?'Today':new Date(d.daily.time[i]).toLocaleDateString('en-NZ',{weekday:'short'})}</div>
                    <div class="fc-d-icon">${getIcon(d.daily.weather_code[i])}</div>
                    <div class="fc-d-sum">${getCodeText(d.daily.weather_code[i])}</div>
                    <div class="fc-d-temps">${Math.round(d.daily.temperature_2m_max[i])}° <span>${Math.round(d.daily.temperature_2m_min[i])}°</span></div>
                </div>`;
            }
            html += '</div>';
            
            c.innerHTML = html;
            document.getElementById('fc-modal-overlay').style.display = 'flex';
        }

        return { init, switchExt };
    })();

    /* --- APP ROUTER --- */
    const app = {
        init: () => { 
            app.fetchData(); 
            window.addEventListener('hashchange', app.route);
            window.addEventListener('load', app.route);
            siWidget.init(); // Start Widget
        },
        route: () => {
            const h = window.location.hash || '#/';
            let id = 'page-home';
            if(h.includes('article')) { id='page-article'; app.loadArticle(h.split('/').pop()); }
            else if(h.includes('outlook')) id='page-outlook';
            else if(h.includes('alerts')) id='page-alerts';
            else if(h.includes('storm')) id='page-storm';
            else if(h.includes('snow')) id='page-snow';
            else if(h.includes('drought')) id='page-drought';
            else if(h.includes('radar')) id='page-radar';
            
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('mm').classList.remove('open');
            
            // Fix Leaflet resizing issue when tabs change
            if(id === 'page-home') setTimeout(() => { window.dispatchEvent(new Event('resize')); }, 100);
            
            window.scrollTo(0,0);
        },
        router: (p) => window.location.hash = p,
        
        fetchData: async () => {
            const now = new Date();

            // 1. ALERTS
            fetch(getFresh(`https://api.jsonbin.io/v3/b/${CONFIG.alerts}/latest`), {headers:{'X-Master-Key':CONFIG.key}}).then(r=>r.json()).then(d => {
                const data = d.record;
                const active = (data.blocks||[]).filter(b => new Date(b.endTime) > now);
                document.getElementById('alerts-overview').innerText = data.globalInfo?.overview || "";
                const c = document.getElementById('alerts-feed'); c.innerHTML = '';
                if(active.length > 0) {
                    document.getElementById('alert-banner').style.display = 'block';
                    document.getElementById('alert-banner').innerHTML = `⚠️ ${active.length} Active Weather Alerts`;
                    document.body.classList.add('has-alert');
                    active.forEach(b => {
                        c.innerHTML += `<div class="alert-card ${b.type==='Critical'?'crit':''}"><div class="ac-head"><span style="font-weight:800; font-size:1.1rem; color:${b.type==='Critical'?'#ef4444':'#f59e0b'}">${b.weatherType}</span><span class="badge bg-${b.type}">${b.type} Risk</span></div><div class="ac-body"><div class="ac-meta"><div><span class="ac-label">Affected Regions</span>${b.regions.join(', ')}</div><div><span class="ac-label">Valid Until</span>${new Date(b.endTime).toLocaleString()}</div></div><p style="white-space:pre-line;">${b.summary}</p></div></div>`;
                    });
                } else { c.innerHTML = '<div style="text-align:center; padding:40px; color:#94a3b8;">No active significant weather alerts.</div>'; }
            });

            // 2. STORMCAST
            fetch(getFresh(`https://api.jsonbin.io/v3/b/${CONFIG.storm}/latest`), {headers:{'X-Master-Key':CONFIG.key}}).then(r=>r.json()).then(d => {
                const active = (d.record.outlooks||[]).filter(o => new Date(o.validUntil) > now);
                const c = document.getElementById('storm-feed'); c.innerHTML = '';
                if(!active.length) c.innerHTML = '<div style="text-align:center; color:#94a3b8">No active StormCast outlooks.</div>';
                active.forEach(o => {
                    let regionsHtml = '';
                    (o.regionalForecasts||[]).forEach(r => {
                        regionsHtml += `<div class="fc-region"><div style="display:flex; justify-content:space-between; margin-bottom:8px;"><strong>${r.regionName}</strong><span class="badge bg-${r.riskLevel}">${r.riskLevel}</span></div><div style="font-size:0.8rem; color:#64748b; margin-bottom:8px;">${r.timing}</div><div class="risk-tags">${(r.risks||[]).map(k=>`<span class="badge" style="background:#cbd5e1; color:#334155;">${k}</span>`).join('')}</div><p style="font-size:0.9rem; margin-top:8px;">${r.threats}</p></div>`;
                    });
                    c.innerHTML += `<div class="fc-wrap"><div class="fc-hero"><h2>${o.title}</h2><div style="font-size:0.9rem; opacity:0.9; margin-top:5px;">Valid: ${new Date(o.validFrom).toLocaleString()} &rarr; ${new Date(o.validUntil).toLocaleString()}</div><p style="margin-top:15px; max-width:700px;">${o.overallDiscussion}</p></div>${o.mapUrl ? `<img src="${o.mapUrl}" class="fc-map" onclick="document.getElementById('lb-img').src=this.src;document.getElementById('lb').style.display='flex'">` : ''}<div class="fc-grid">${regionsHtml}</div></div>`;
                });
            });

            // 3. SNOWCAST
            fetch(getFresh(`https://api.jsonbin.io/v3/b/${CONFIG.snow}/latest`), {headers:{'X-Master-Key':CONFIG.key}}).then(r=>r.json()).then(d => {
                const data = d.record;
                document.getElementById('sc-main-title').innerText = data.mainTitle || "SnowCast";
                document.getElementById('sc-main-overview').innerText = data.overview || "";
                const active = (data.forecasts||[]).filter(f => new Date(f.validTo) > now);
                const c = document.getElementById('snow-feed'); c.innerHTML = '';
                if(!active.length) c.innerHTML = '<div style="text-align:center; color:#94a3b8">No active SnowCast warnings.</div>';
                active.forEach(f => { c.innerHTML += `<div class="alert-card"><div class="ac-head"><strong>${f.region}</strong><span class="badge bg-${f.riskLevel}">${f.riskLevel} Snow Risk</span></div><div class="ac-body"><div class="ac-meta"><div><span class="ac-label">Valid From</span>${new Date(f.validFrom).toLocaleString()}</div><div><span class="ac-label">Valid To</span>${new Date(f.validTo).toLocaleString()}</div></div><p>${f.summary}</p></div></div>`; });
            });

            // 4. SWO
            fetch(getFresh(`https://api.jsonbin.io/v3/b/${CONFIG.sig}/latest`), {headers:{'X-Master-Key':CONFIG.key}}).then(r=>r.json()).then(d => {
                document.getElementById('swo-title').innerText = d.record.overallTitle || "";
                document.getElementById('swo-summary').innerText = d.record.overallSummary || "";
                const c = document.getElementById('outlook-container'); c.innerHTML = '';
                const todayStart = new Date(); todayStart.setHours(0,0,0,0);
                const active = (d.record.forecasts||[]).filter(f => new Date(f.date) >= todayStart);
                active.forEach(f => { c.innerHTML += `<div class="swo-card">${f.imageUrl ? `<img src="${f.imageUrl}" class="swo-img" onclick="document.getElementById('lb-img').src=this.src;document.getElementById('lb').style.display='flex'">` : ''}<div><h3 style="margin-bottom:5px;">${new Date(f.date).toLocaleDateString('en-NZ', {weekday:'long', day:'numeric', month:'long'})}</h3><span class="badge bg-${f.alertLevel}">${f.alertLevel || 'Low'} Risk</span><p style="margin-top:10px; color:#475569;">${f.summary}</p></div></div>`; });
            });

            // 5. NEWS
            fetch(getFresh(`https://api.jsonbin.io/v3/b/${CONFIG.news}/latest`), {headers:{'X-Master-Key':CONFIG.key}}).then(r=>r.json()).then(d => {
                window.newsData = d.record.news || [];
                const c = document.getElementById('news-feed'); c.innerHTML = '';
                window.newsData.sort((a,b) => new Date(b.scheduledAt) - new Date(a.scheduledAt));
                window.newsData.forEach((n, i) => {
                    const id = n.scheduledAt ? new Date(n.scheduledAt).getTime() : i;
                    const snip = n.content.replace(/<[^>]*>?/gm, '').substring(0, 100) + '...';
                    c.innerHTML += `<div class="news-card" onclick="app.router('#/article/${id}')"><div class="nc-img" style="background-image:url('${n.titleImg && n.titleImg !== 'MOCK_URL' ? n.titleImg : 'logo.png'}')"></div><div class="nc-body"><div class="nc-date">${new Date(n.scheduledAt).toLocaleDateString()} • ${n.tag}</div><div class="nc-title">${n.title}</div><p style="font-size:0.9rem; color:#64748b; margin-bottom:15px;">${snip}</p><div class="nc-link">${n.linkText || 'Read Full Story &rarr;'}</div></div></div>`;
                });
            });

            // 6. DROUGHT
            fetch(getFresh(`https://api.jsonbin.io/v3/b/${CONFIG.drought}/latest`), {headers:{'X-Master-Key':CONFIG.key}}).then(r=>r.json()).then(d => {
                document.getElementById('dc-title').innerText = d.record.overview?.title || "";
                document.getElementById('dc-sum').innerText = d.record.overview?.summary || "";
                const c = document.getElementById('dc-feed'); c.innerHTML = '';
                (d.record.alerts||[]).forEach(a => { c.innerHTML += `<div class="dc-card"><div style="display:flex; justify-content:space-between; margin-bottom:10px;"><strong>${a.region}</strong><span class="badge bg-${a.severity}">${a.severity}</span></div><div class="ac-meta"><div><span class="ac-label">Rain Potential</span>${a.rainPotential}</div><div><span class="ac-label">Expires</span>${new Date(a.endDate).toLocaleDateString()}</div></div><p>${a.summary}</p></div>`; });
            });
        },

        loadArticle: (id) => {
            const c = document.getElementById('article-content');
            c.innerHTML = '<p style="text-align:center">Loading article...</p>';
            if(!window.newsData) { setTimeout(() => app.loadArticle(id), 500); return; }
            const art = window.newsData.find(n => (new Date(n.scheduledAt).getTime() == id));
            if(art) {
                c.innerHTML = `<div class="art-header"><div style="color:#94a3b8; font-size:0.9rem; text-transform:uppercase; font-weight:700; margin-bottom:10px;">${art.tag} • ${new Date(art.scheduledAt).toLocaleDateString()}</div><h1 style="font-size:2rem; color:#0f172a; max-width:800px; margin:0 auto;">${art.title}</h1></div>${art.titleImg && art.titleImg !== 'MOCK_URL' ? `<img src="${art.titleImg}" class="art-img">` : ''}<div class="art-body">${art.content}</div>`;
            } else { c.innerHTML = '<p style="text-align:center; color:red;">Article not found.</p>'; }
        }
    };

    document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>
